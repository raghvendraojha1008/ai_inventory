PROJECT DOCUMENTATION
=====================



--- FILE START: src\App.tsx ---
import React, { useState, useEffect } from 'react';
import { ApiService } from './services/api';
import { AppSettings } from './types';
import { DEFAULT_SETTINGS } from './config/constants';
import { AuthProvider, useAuth } from './context/AuthContext';
import { UIProvider } from './context/UIContext';
import LoginView from './components/auth/LoginView';
import DashboardView from './components/views/DashboardView';
import LedgerView from './components/views/LedgerView';
import TransactionsView from './components/views/TransactionsView';
import InventoryView from './components/views/InventoryView';
import PartiesView from './components/views/PartiesView';
import VehiclesView from './components/views/VehiclesView';
import SettingsView from './components/views/SettingsView';
import ExpensesView from './components/views/ExpensesView';
import ReportsView from './components/views/ReportsView';
import CommandModal from './components/common/CommandModal';
import LockScreen from './components/common/LockScreen';
import ManualEntryModal from './components/modals/ManualEntryModal'; // Imported
import { Mic, LayoutDashboard, BookOpen, Users, Settings } from 'lucide-react';

const AppContent = () => {
  const { user, loading } = useAuth();
  const [activeTab, setActiveTab] = useState('dashboard');
  const [appSettings, setAppSettings] = useState<AppSettings>(DEFAULT_SETTINGS);
  const [showAI, setShowAI] = useState(false);
  const [isLocked, setIsLocked] = useState(false);
  const [hasInitialLockCheck, setHasInitialLockCheck] = useState(false);
  
  // Manual Entry State
  const [entryModal, setEntryModal] = useState<{ open: boolean; type: string; data?: any }>({ open: false, type: 'sales' });

  useEffect(() => {
      if (appSettings.preferences?.dark_mode) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
  }, [appSettings.preferences?.dark_mode]);

  useEffect(() => {
    if (user) {
        const loadSettings = async () => {
             const savedData = await ApiService.settings.get(user.uid);
             if (savedData) setAppSettings({ ...DEFAULT_SETTINGS, ...savedData });
        };
        loadSettings();
    }
  }, [user]);

  useEffect(() => {
       if (user && appSettings.security?.enabled && appSettings.security?.pin && !hasInitialLockCheck) {
           setIsLocked(true);
           setHasInitialLockCheck(true);
       }
  }, [appSettings.security, user, hasInitialLockCheck]);

  const updateSettings = (newSettings: AppSettings) => setAppSettings(newSettings);

  const openManual = (type: string, data?: any) => setEntryModal({ open: true, type, data });

  const handleQuickAction = (action: string) => {
      if (action === 'ai') return setShowAI(true);
      if (action === 'sale') return openManual('sales');
      if (action === 'purchase') return openManual('purchases');
      if (action === 'payment') return openManual('transactions');
      if (action === 'expense') return openManual('expenses');
      if (action === 'vehicle') return setActiveTab('vehicles');
  };

  if (loading) return <div className="h-screen w-screen flex items-center justify-center bg-slate-50 dark:bg-slate-950 font-bold text-slate-400">Loading...</div>;
  if (!user) return <LoginView />;

  return (
    <div className={`h-screen w-screen flex flex-col overflow-hidden transition-colors duration-200 ${appSettings.preferences?.dark_mode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
       {isLocked ? (
           <LockScreen pin={appSettings.security?.pin || '0000'} onUnlock={() => setIsLocked(false)} enableBiometrics={appSettings.security?.enable_biometrics} /> 
       ) : (
           <>
               <div className="flex-1 overflow-hidden relative pt-12">
                   {activeTab === 'dashboard' && <DashboardView user={user} appSettings={appSettings} onNavigate={setActiveTab} onQuickAction={handleQuickAction} />}
                   {/* WIRED: '+' buttons now open Manual Entry Forms */}
                   {activeTab === 'ledger' && <LedgerView user={user} onAdd={() => openManual('sales')} />}
                   {activeTab === 'transactions' && <TransactionsView user={user} onAdd={() => openManual('transactions')} />}
                   {activeTab === 'inventory' && <InventoryView user={user} settings={appSettings} onAdd={() => openManual('inventory')} />}
                   {activeTab === 'parties' && <PartiesView user={user} />}
                   {activeTab === 'vehicles' && <VehiclesView user={user} />}
                   {activeTab === 'expenses' && <ExpensesView user={user} appSettings={appSettings} onEdit={(item) => openManual('expenses', item)} />}
                   {activeTab === 'reports' && <ReportsView user={user} onBack={() => setActiveTab('dashboard')} />}
                   {activeTab === 'settings' && <div className="h-full block"><SettingsView user={user} appSettings={appSettings} onUpdateSettings={updateSettings} onBack={() => setActiveTab('dashboard')} /></div>}
               </div>

               {activeTab !== 'settings' && (
                   <div className="bg-white dark:bg-slate-900 border-t dark:border-slate-800 p-2 pb-6 flex justify-around items-center safe-area-bottom z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                       <NavBtn id="dashboard" label="Home" icon={LayoutDashboard} active={activeTab} onClick={setActiveTab} />
                       <NavBtn id="ledger" label="Ledger" icon={BookOpen} active={activeTab} onClick={setActiveTab} />
                       <div className="relative -top-6">
                           <button onClick={() => setShowAI(true)} className="w-16 h-16 bg-slate-900 dark:bg-blue-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-slate-900/30 active:scale-95 transition-all border-4 border-slate-50 dark:border-slate-950">
                               <Mic size={28} />
                           </button>
                       </div>
                       <NavBtn id="parties" label="Parties" icon={Users} active={activeTab} onClick={setActiveTab} />
                       <NavBtn id="settings" label="Settings" icon={Settings} active={activeTab} onClick={setActiveTab} />
                   </div>
               )}

               {showAI && <CommandModal isOpen={showAI} onClose={() => setShowAI(false)} user={user} onSuccess={() => {}} appSettings={appSettings} />}
               
               {/* WIRED: Manual Entry Modal */}
               {entryModal.open && (
                   <ManualEntryModal 
                       isOpen={entryModal.open} 
                       onClose={() => setEntryModal({ ...entryModal, open: false })}
                       type={entryModal.type}
                       user={user}
                       initialData={entryModal.data}
                       appSettings={appSettings}
                   />
               )}
           </>
       )}
    </div>
  );
};

const NavBtn = ({ id, label, icon: Icon, active, onClick }: any) => (
    <button onClick={() => onClick(id)} className={`flex flex-col items-center gap-1 p-2 transition-all ${active === id ? 'text-slate-900 dark:text-blue-400 scale-110' : 'text-slate-400 dark:text-slate-600'}`}>
        <Icon size={24} strokeWidth={active === id ? 3 : 2} />
        <span className="text-[9px] font-bold uppercase tracking-wider">{label}</span>
    </button>
);

export default function App() {
  return (
    <AuthProvider>
      <UIProvider>
        <AppContent />
      </UIProvider>
    </AuthProvider>
  );
}

--- FILE END: src\App.tsx ---


--- FILE START: src\components\auth\LoginView.tsx ---
import React from 'react';
import { useAuth } from '../../context/AuthContext';
import { ShoppingBag } from 'lucide-react';

const LoginView = () => {
  const { loginWithGoogle, loading } = useAuth();

  return (
    <div className="h-screen w-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-950 p-4 transition-colors">
      <div className="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border border-slate-100 dark:border-slate-800">
        <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-blue-600/30">
          <ShoppingBag size={32} />
        </div>
        <h1 className="text-2xl font-black text-slate-900 dark:text-white mb-2">Shop Ledger</h1>
        <p className="text-slate-500 dark:text-slate-400 mb-8">Manage your business with AI</p>
        
        <button 
          onClick={loginWithGoogle} 
          disabled={loading}
          className="w-full py-4 bg-slate-900 dark:bg-blue-600 text-white font-bold rounded-xl active:scale-95 transition-all flex items-center justify-center gap-2"
        >
          {loading ? 'Connecting...' : 'Continue with Google'}
        </button>
      </div>
    </div>
  );
};
export default LoginView;

--- FILE END: src\components\auth\LoginView.tsx ---


--- FILE START: src\components\cards\ExpenseRow.tsx ---
import React from 'react';
import { Wallet, Edit2, Trash2 } from 'lucide-react';
import { formatDate, formatCurrency } from '../../utils/helpers';

interface ExpenseRowProps {
  e: any;
  onEdit: (item: any) => void;
  onDelete: (id: string) => void;
}

const ExpenseRow: React.FC<ExpenseRowProps> = React.memo(({ e, onEdit, onDelete }) => (
  <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-100 flex justify-between items-center hover:bg-slate-50">
    <div className="flex items-center gap-3">
      <div className="p-3 bg-orange-100 text-orange-600 rounded-xl"><Wallet size={20}/></div>
      <div>
        <h4 className="font-bold capitalize text-slate-800">{e.type} Expense</h4>
        <div className="text-xs text-slate-500">{e.note}</div>
        {e.type === 'salary' && <div className="text-xs font-semibold text-blue-600 mt-1">To: {e.employee_name}</div>}
      </div>
    </div>
    <div className="text-right">
      <div className="font-bold text-red-600 text-lg">-{formatCurrency(e.amount)}</div>
      <div className="text-xs text-slate-400">{formatDate(e.date)}</div>
      <div className="flex justify-end gap-2 mt-1 no-print">
        <button onClick={() => onEdit(e)} className="text-blue-500 p-1 hover:bg-blue-50 rounded"><Edit2 size={14}/></button>
        <button onClick={(ev) => { ev.stopPropagation(); onDelete(e.id); }} className="text-red-500 p-1 hover:bg-red-50 rounded"><Trash2 size={14}/></button>
      </div>
    </div>
  </div>
));

export default ExpenseRow;
--- FILE END: src\components\cards\ExpenseRow.tsx ---


--- FILE START: src\components\cards\InventoryCard.tsx ---
import React from 'react';
import { Edit2, Trash2, Package, Layers, AlertTriangle, Tag, IndianRupee } from 'lucide-react';
import { formatCurrency } from '../../utils/helpers';
import { Highlighter } from '../common/Highlighter';

interface InventoryCardProps {
  i: any;
  onEdit: (item: any) => void;
  onDelete: (id: string) => void;
  showDelete?: boolean;
  searchTerm?: string;
}

const InventoryCard: React.FC<InventoryCardProps> = ({ i, onEdit, onDelete, showDelete = true, searchTerm = '' }) => {
  const minStock = i.min_stock || 5;
  const isLowStock = (i.current_stock || 0) <= minStock;
  // Fallback for old data: use default_rate if sale_rate is missing
  const saleRate = i.sale_rate || i.default_rate || 0;

  return (
    <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col justify-between group relative overflow-hidden">
      {isLowStock && (
          <div className="absolute top-0 right-0 bg-red-500 text-white text-[9px] font-bold px-2 py-1 rounded-bl-lg z-10 flex items-center gap-1">
              <AlertTriangle size={10} /> LOW
          </div>
      )}
      <div>
          <div className="flex justify-between items-start mb-2">
            <div>
                <h3 className="font-bold text-base text-slate-800 line-clamp-1 pr-2">
                    <Highlighter text={i.name} highlight={searchTerm} />
                </h3>
                {i.hsn_code && <span className="text-[10px] text-slate-400 font-mono">HSN: {i.hsn_code}</span>}
            </div>
            <span className="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-600 flex-shrink-0">{i.unit}</span>
          </div>
          
          <div className="grid grid-cols-2 gap-2 mb-2">
             <div className={`p-2 rounded-lg ${isLowStock ? 'bg-red-50 border border-red-100' : 'bg-slate-50'}`}>
                 <div className={`text-[10px] uppercase font-bold ${isLowStock ? 'text-red-500' : 'text-slate-400'}`}>Stock</div>
                 <div className={`text-sm font-bold flex items-center gap-1 ${isLowStock ? 'text-red-700' : 'text-slate-800'}`}>
                    <Layers size={12} className={isLowStock ? 'text-red-500' : 'text-blue-500'}/> {i.current_stock}
                 </div>
             </div>
             <div className="p-2 bg-green-50 rounded-lg">
                 <div className="text-[10px] text-green-600 uppercase font-bold">Sell Price</div>
                 <div className="text-sm font-bold text-green-800 tabular-nums">
                    {formatCurrency(saleRate)}
                 </div>
             </div>
          </div>
          
          {/* Detailed Info Row */}
          <div className="flex items-center justify-between text-[10px] text-slate-400 px-1">
              <span>Buy: {formatCurrency(i.purchase_rate || 0)}</span>
              <span>GST: {i.gst_percent || 0}%</span>
          </div>
      </div>
      
      <div className="flex gap-2 pt-3 border-t border-slate-50 mt-2">
        <button onClick={() => onEdit(i)} className="flex-1 py-2 text-xs font-bold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 flex items-center justify-center gap-2 transition-colors">
            <Edit2 size={14}/> Edit
        </button>
        {showDelete && (
            <button onClick={() => onDelete(i.id)} className="flex-1 py-2 text-xs font-bold text-red-600 bg-red-50 rounded-lg hover:bg-red-100 flex items-center justify-center gap-2 transition-colors">
                <Trash2 size={14}/> Delete
            </button>
        )}
      </div>
    </div>
  );
};

export default InventoryCard;
--- FILE END: src\components\cards\InventoryCard.tsx ---


--- FILE START: src\components\cards\LedgerCard.tsx ---
import React from 'react';
import { Edit2, Trash2, Calendar, Truck, Package, Hash, CreditCard, Banknote, Printer, Share2 } from 'lucide-react'; // Added Share2
import { formatDate, formatCurrency } from '../../utils/helpers';
import { Highlighter } from '../common/Highlighter';

interface LedgerCardProps {
  l: any;
  onEdit: (item: any) => void;
  onDelete: (id: string) => void;
  onPrint?: (item: any) => void;
  showDelete?: boolean;
  searchTerm?: string;
}

const LedgerCard: React.FC<LedgerCardProps> = ({ l, onEdit, onDelete, onPrint, showDelete = true, searchTerm = '' }) => {
  const isPurchase = l.type === 'purchase';
  const itemCount = l.items ? l.items.length : 0;
  const firstItem = l.items && l.items[0] ? l.items[0].item_name : (l.item_name || 'General Item');

  const handleShare = (e: React.MouseEvent) => {
      e.stopPropagation();
      const text = `*Invoice Details*\nType: ${isPurchase ? 'Purchase' : 'Sale'}\nParty: ${l.party_name}\nDate: ${formatDate(l.date)}\nAmount: ${formatCurrency(l.total_amount)}\nInvoice No: ${l.invoice_no || 'NA'}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
  };

  return (
    <div className="group bg-white rounded-xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden">
      <div className={`absolute left-0 top-0 bottom-0 w-1 ${isPurchase ? 'bg-orange-500' : 'bg-blue-500'}`}></div>
      
      <div className="flex justify-between items-start mb-3 pl-2">
        <div>
            <div className="flex items-center gap-2 mb-1">
                <h3 className="font-bold text-base text-slate-800 leading-none">
                    <Highlighter text={l.party_name} highlight={searchTerm} />
                </h3>
                {l.invoice_no && (
                    <span className="text-[10px] font-mono bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded flex items-center gap-1">
                        <Hash size={10}/> <Highlighter text={l.invoice_no} highlight={searchTerm} />
                    </span>
                )}
            </div>
            <div className="flex items-center gap-3 text-xs text-slate-400">
                <span className="flex items-center gap-1"><Calendar size={12}/> {formatDate(l.date)}</span>
                {l.vehicle && (
                    <span className="flex items-center gap-1 text-slate-500">
                        <Truck size={12}/> <Highlighter text={l.vehicle} highlight={searchTerm} />
                    </span>
                )}
            </div>
        </div>
        <div className="text-right">
            <div className="text-base font-bold text-slate-900 tabular-nums">{formatCurrency(l.total_amount)}</div>
            <div className={`text-[10px] font-bold uppercase flex items-center justify-end gap-1 ${isPurchase ? 'text-orange-600' : 'text-blue-600'}`}>
                {l.payment_mode === 'online' ? <CreditCard size={10}/> : <Banknote size={10}/>}
                {l.payment_mode || 'Cash'}
            </div>
        </div>
      </div>

      <div className="bg-slate-50 rounded-lg p-2.5 flex items-center justify-between ml-2">
         <div className="flex items-center gap-2 text-xs text-slate-600">
            <Package size={14} className="text-slate-400"/>
            <span className="font-medium truncate max-w-[140px]">
                <Highlighter text={firstItem} highlight={searchTerm} />
            </span>
            {itemCount > 1 && <span className="text-[10px] bg-white border border-slate-200 text-slate-500 px-1.5 rounded-full font-bold">+{itemCount - 1} more</span>}
         </div>
         
         <div className="flex items-center gap-2">
            {/* WhatsApp Share Button */}
            <button onClick={handleShare} className="text-green-500 hover:text-green-600 p-1.5 bg-white rounded-full shadow-sm hover:shadow active:scale-95 transition-all">
                <Share2 size={14} />
            </button>
            {onPrint && (
                <button onClick={(e) => { e.stopPropagation(); onPrint(l); }} className="text-slate-400 hover:text-slate-800 p-1.5 bg-white rounded-full shadow-sm hover:shadow active:scale-95 transition-all">
                    <Printer size={14} />
                </button>
            )}
            <button onClick={() => onEdit(l)} className="text-slate-400 hover:text-blue-600 p-1.5 bg-white rounded-full shadow-sm hover:shadow transition-colors">
                <Edit2 size={14} />
            </button>
            {showDelete && (
                <button onClick={() => onDelete(l.id)} className="text-slate-400 hover:text-red-600 p-1.5 bg-white rounded-full shadow-sm hover:shadow transition-colors">
                    <Trash2 size={14} />
                </button>
            )}
         </div>
      </div>
    </div>
  );
};

export default LedgerCard;
--- FILE END: src\components\cards\LedgerCard.tsx ---


--- FILE START: src\components\cards\PartyCard.tsx ---
import React from 'react';
import { Edit2, Trash2, Phone, MapPin, CreditCard } from 'lucide-react';
import { Highlighter } from '../common/Highlighter';
import { formatCurrency } from '../../utils/helpers';

interface PartyCardProps {
  p: any;
  onEdit: (item: any) => void;
  onDelete: (id: string) => void;
  onSelect: (p: any) => void;
  showDelete?: boolean;
  searchTerm?: string;
}

const PartyCard: React.FC<PartyCardProps> = ({ p, onEdit, onDelete, onSelect, showDelete = true, searchTerm = '' }) => {
  return (
    <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all group">
      <div onClick={() => onSelect(p)} className="cursor-pointer">
          <div className="flex justify-between items-start mb-2">
            <div>
                <h3 className="font-bold text-lg text-slate-800">
                    <Highlighter text={p.name} highlight={searchTerm} />
                </h3>
                {p.gstin && <span className="text-[10px] text-slate-400 font-mono block">GSTIN: <Highlighter text={p.gstin} highlight={searchTerm} /></span>}
            </div>
            <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${p.role === 'customer' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700'}`}>
                {p.role}
            </span>
          </div>
          
          <div className="space-y-1.5 mb-4">
            <div className="flex items-center gap-2 text-sm text-slate-600">
                <Phone size={14} className="text-slate-400"/> 
                <Highlighter text={p.contact || 'No Contact'} highlight={searchTerm} />
            </div>
            <div className="flex items-center gap-2 text-sm text-slate-600 truncate">
                <MapPin size={14} className="text-slate-400 flex-shrink-0"/> 
                <Highlighter text={p.city || p.address || 'No Address'} highlight={searchTerm} />
            </div>
            {p.opening_balance > 0 && (
                <div className="flex items-center gap-2 text-xs text-orange-600 font-medium">
                    <CreditCard size={12} /> Op. Bal: {formatCurrency(p.opening_balance)}
                </div>
            )}
          </div>
      </div>
      
      <div className="flex gap-2 pt-3 border-t border-slate-50">
        <button onClick={() => onEdit(p)} className="flex-1 py-2 text-xs font-bold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 flex items-center justify-center gap-2 transition-colors">
            <Edit2 size={14}/> Edit
        </button>
        {showDelete && (
            <button onClick={() => onDelete(p.id)} className="flex-1 py-2 text-xs font-bold text-red-600 bg-red-50 rounded-lg hover:bg-red-100 flex items-center justify-center gap-2 transition-colors">
                <Trash2 size={14}/> Delete
            </button>
        )}
      </div>
    </div>
  );
};

export default PartyCard;
--- FILE END: src\components\cards\PartyCard.tsx ---


--- FILE START: src\components\cards\TransactionRow.tsx ---
import React from 'react';
import { ArrowUpRight, ArrowDownLeft, Edit2, Trash2, Calendar } from 'lucide-react';
import { formatDate, formatCurrency } from '../../utils/helpers';
import { Highlighter } from '../common/Highlighter';

interface TransactionRowProps {
  t: any;
  onEdit: (item: any) => void;
  onDelete: (id: string) => void;
  showDelete?: boolean;
  searchTerm?: string;
}

const TransactionRow: React.FC<TransactionRowProps> = ({ t, onEdit, onDelete, showDelete = true, searchTerm = '' }) => {
  const isReceived = t.type === 'received';
  
  return (
    <div className="group bg-white rounded-lg p-3 border border-slate-100 hover:border-blue-200 transition-all shadow-sm hover:shadow-md flex items-center justify-between gap-3">
      {/* Icon & Main Info */}
      <div className="flex items-center gap-3 overflow-hidden flex-1">
        <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${isReceived ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
          {isReceived ? <ArrowDownLeft size={18} /> : <ArrowUpRight size={18} />}
        </div>
        
        <div className="min-w-0 flex-1">
          <div className="flex items-center gap-2">
            <h3 className="font-bold text-sm text-slate-800 truncate">
                <Highlighter text={t.party_name} highlight={searchTerm} />
            </h3>
            <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-500 font-medium uppercase tracking-wide">
              {t.payment_mode}
            </span>
          </div>
          <div className="flex items-center gap-3 mt-0.5">
            <span className="text-xs text-slate-400 flex items-center gap-1">
               <Calendar size={10}/> {formatDate(t.date)}
            </span>
            {t.notes && (
                <span className="text-xs text-slate-400 truncate max-w-[120px] border-l border-slate-200 pl-2">
                    <Highlighter text={t.notes} highlight={searchTerm} />
                </span>
            )}
          </div>
        </div>
      </div>

      {/* Amount & Actions */}
      <div className="text-right flex flex-col items-end">
        <span className={`text-sm font-bold tabular-nums ${isReceived ? 'text-green-600' : 'text-slate-800'}`}>
          {isReceived ? '+' : '-'}{formatCurrency(t.amount)}
        </span>
        
        {/* Actions are always visible on touch, or hover on desktop */}
        <div className="flex items-center gap-3 mt-1.5 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
          <button onClick={() => onEdit(t)} className="text-slate-400 hover:text-blue-600 transition-colors p-1">
            <Edit2 size={16} />
          </button>
          {showDelete && (
              <button onClick={() => onDelete(t.id)} className="text-slate-400 hover:text-red-600 transition-colors p-1">
                <Trash2 size={16} />
              </button>
          )}
        </div>
      </div>
    </div>
  );
};

export default TransactionRow;
--- FILE END: src\components\cards\TransactionRow.tsx ---


--- FILE START: src\components\cards\VehicleCard.tsx ---
import React from 'react';
import { Edit2, Trash2, Phone, User, Truck, Car } from 'lucide-react'; // Fixed: Replaced SteeringWheel with Car
import { formatDate } from '../../utils/helpers';
import { Highlighter } from '../common/Highlighter'; 

interface VehicleCardProps {
  v: any;
  onEdit: (item: any) => void;
  onDelete: (id: string) => void;
  onSelect: (v: any) => void;
  showDelete?: boolean;
  searchTerm?: string;
}

const VehicleCard: React.FC<VehicleCardProps> = ({ v, onEdit, onDelete, onSelect, showDelete = true, searchTerm = '' }) => {
  return (
    <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all group">
      <div onClick={() => onSelect(v)} className="cursor-pointer">
          <div className="flex justify-between items-start mb-2">
            <div>
                <h3 className="font-bold text-lg text-slate-800 uppercase bg-slate-100 px-2 py-1 rounded inline-block">
                    <Highlighter text={v.vehicle_number} highlight={searchTerm} />
                </h3>
                {v.vehicle_model && (
                    <div className="text-xs text-slate-500 mt-1 flex items-center gap-1">
                        <Car size={12} className="text-slate-400"/>
                        {v.vehicle_model}
                    </div>
                )}
            </div>
            <span className="text-xs text-slate-400">{formatDate(v.created_at)}</span>
          </div>
          
          <div className="space-y-1.5 mb-4">
            <div className="flex items-center gap-2 text-sm text-slate-600">
                <User size={14} className="text-slate-400"/> 
                <span className="text-slate-400 text-xs uppercase mr-1">Owner:</span>
                <Highlighter text={v.owner_name} highlight={searchTerm} />
            </div>
            {v.driver_name && (
                <div className="flex items-center gap-2 text-sm text-slate-600">
                    <Truck size={14} className="text-slate-400"/>
                    <span className="text-slate-400 text-xs uppercase mr-1">Driver:</span>
                    <Highlighter text={v.driver_name} highlight={searchTerm} />
                </div>
            )}
            <div className="flex items-center gap-2 text-sm text-slate-600">
                <Phone size={14} className="text-slate-400"/> 
                <Highlighter text={v.contact || 'No Contact'} highlight={searchTerm} />
            </div>
          </div>
      </div>
      
      <div className="flex gap-2 pt-3 border-t border-slate-50">
        <button onClick={() => onEdit(v)} className="flex-1 py-2 text-xs font-bold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 flex items-center justify-center gap-2 transition-colors">
            <Edit2 size={14}/> Edit
        </button>
        {showDelete && (
            <button onClick={() => onDelete(v.id)} className="flex-1 py-2 text-xs font-bold text-red-600 bg-red-50 rounded-lg hover:bg-red-100 flex items-center justify-center gap-2 transition-colors">
                <Trash2 size={14}/> Delete
            </button>
        )}
      </div>
    </div>
  );
};

export default VehicleCard;
--- FILE END: src\components\cards\VehicleCard.tsx ---


--- FILE START: src\components\common\CommandModal.tsx ---
import React, { useState } from 'react';
import { User } from 'firebase/auth';
import { X, Mic, Send, Image as ImageIcon, Loader2, AlertTriangle } from 'lucide-react';
import { GeminiService } from '../../services/gemini';
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import { AppSettings } from '../../types';
import { haptic } from '../../utils/haptics';

interface CommandModalProps {
  isOpen: boolean;
  onClose: () => void;
  user: User;
  onSuccess?: () => void;    // Added Prop
  appSettings?: AppSettings; // Added Prop
}

const CommandModal: React.FC<CommandModalProps> = ({ isOpen, onClose, user, onSuccess, appSettings }) => {
  const { showToast } = useUI();
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [file, setFile] = useState<File | null>(null);

  const handleProcess = async () => {
      if (!input.trim() && !file) return;
      setLoading(true);
      setError('');
      haptic.medium();
      
      try {
          const commands = await GeminiService.processInput(input, file);
          
          if (!commands || commands.length === 0) {
              throw new Error("Could not understand command.");
          }

          let count = 0;
          for (const cmd of commands) {
              const { collection, ...data } = cmd;
              if (collection) {
                  await ApiService.add(user.uid, collection, { 
                      ...data, 
                      created_at: new Date().toISOString() 
                  });
                  count++;
              }
          }
          
          showToast(`${count} Actions Processed`, 'success');
          haptic.success();
          
          if (onSuccess) onSuccess(); // Trigger refresh
          
          setInput('');
          setFile(null);
          onClose();

      } catch (e: any) {
          console.error(e);
          haptic.error();
          setError(e.message || "Processing failed");
      } finally {
          setLoading(false);
      }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-3xl overflow-hidden shadow-2xl border border-slate-100 dark:border-slate-800 flex flex-col max-h-[90vh]">
            <div className="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <div>
                    <h2 className="font-bold text-lg text-slate-900 dark:text-white">AI Command Center</h2>
                    <p className="text-xs text-slate-500">Type, or Upload Image/Audio</p>
                </div>
                <button onClick={onClose} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full dark:text-white"><X size={20}/></button>
            </div>

            {error && (
                <div className="bg-red-50 dark:bg-red-900/20 p-3 flex gap-2 items-center text-red-600 dark:text-red-400 text-xs font-bold px-6">
                    <AlertTriangle size={14}/> {error}
                </div>
            )}

            <div className="p-4 space-y-4 flex-1 overflow-y-auto">
                <textarea 
                    className="w-full h-32 p-4 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl resize-none outline-none focus:ring-2 focus:ring-blue-500 font-medium text-sm"
                    placeholder="e.g. 'Add customer Mohit from Delhi'"
                    value={input}
                    onChange={e => setInput(e.target.value)}
                />
                
                <label className="flex items-center justify-center gap-2 w-full p-4 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <input type="file" className="hidden" accept="image/*,audio/*" onChange={e => setFile(e.target.files?.[0] || null)} />
                    <ImageIcon size={20} className="text-slate-400" />
                    <span className="text-sm font-bold text-slate-500 dark:text-slate-400">{file ? file.name : "Upload Image (OCR) or Audio"}</span>
                </label>
            </div>

            <div className="p-4 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-950">
                <button 
                    onClick={handleProcess} 
                    disabled={loading || (!input && !file)}
                    className="w-full py-3 bg-slate-900 dark:bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 active:scale-95 transition-all"
                >
                    {loading ? <Loader2 size={20} className="animate-spin" /> : <><Send size={18} /> Process Command</>}
                </button>
            </div>
        </div>
    </div>
  );
};
export default CommandModal;

--- FILE END: src\components\common\CommandModal.tsx ---


--- FILE START: src\components\common\ConfirmDialog.tsx ---
import React from 'react';
import { AlertTriangle } from 'lucide-react';

interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  onConfirm: () => void;
  onCancel: () => void;
}

const ConfirmDialog: React.FC<ConfirmDialogProps> = ({ isOpen, title, message, onConfirm, onCancel }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 scale-100 animate-in zoom-in-95 duration-200">
        <div className="flex items-center gap-3 mb-4 text-amber-600">
            <div className="p-2 bg-amber-100 rounded-full"><AlertTriangle size={24} /></div>
            <h3 className="text-xl font-bold text-slate-900">{title}</h3>
        </div>
        <p className="text-slate-600 mb-6 leading-relaxed">{message}</p>
        <div className="flex gap-3 justify-end">
          <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-100 rounded-lg transition-colors">Cancel</button>
          <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-md transition-colors">Confirm Action</button>
        </div>
      </div>
    </div>
  );
};

export default ConfirmDialog;
--- FILE END: src\components\common\ConfirmDialog.tsx ---


--- FILE START: src\components\common\CountUp.tsx ---
import React, { useEffect, useState } from 'react';
import { formatCurrency } from '../../utils/helpers';

interface CountUpProps {
  end: number;
  duration?: number;
  prefix?: string;
  isCurrency?: boolean;
}

export const CountUp: React.FC<CountUpProps> = ({ end, duration = 1000, prefix = '', isCurrency = false }) => {
  const [count, setCount] = useState(0);

  useEffect(() => {
    let startTime: number | null = null;
    const start = 0;
    
    const step = (timestamp: number) => {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      
      // Easing function (easeOutExpo)
      const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
      
      setCount(start + (end - start) * ease);

      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };

    window.requestAnimationFrame(step);
  }, [end, duration]);

  const display = isCurrency ? formatCurrency(count) : Math.floor(count);

  return <span className="tabular-nums">{display}</span>;
};
--- FILE END: src\components\common\CountUp.tsx ---


--- FILE START: src\components\common\EmptyState.tsx ---
import React from 'react';
import { LucideIcon } from 'lucide-react';

interface EmptyStateProps {
    icon: LucideIcon;
    title: string;
    description: string;
    actionLabel?: string;
    onAction?: () => void;
}

const EmptyState: React.FC<EmptyStateProps> = ({ icon: Icon, title, description, actionLabel, onAction }) => (
    <div className="flex flex-col items-center justify-center py-12 px-4 text-center fade-in">
        <div className="bg-slate-100 p-6 rounded-full mb-4 shadow-inner">
            <Icon size={32} className="text-slate-400" />
        </div>
        <h3 className="text-lg font-bold text-slate-700 mb-1">{title}</h3>
        <p className="text-sm text-slate-400 max-w-xs mx-auto mb-6 leading-relaxed">{description}</p>
        {actionLabel && onAction && (
            <button 
                onClick={onAction} 
                className="text-blue-600 font-bold text-sm bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors active:scale-95"
            >
                {actionLabel}
            </button>
        )}
    </div>
);

export default EmptyState;
--- FILE END: src\components\common\EmptyState.tsx ---


--- FILE START: src\components\common\ErrorBoundary.tsx ---
import React, { Component, ErrorInfo, ReactNode } from 'react';

interface Props { children: ReactNode; }
interface State { hasError: boolean; }

export class ErrorBoundary extends Component<Props, State> {
  public state: State = { hasError: false };

  public static getDerivedStateFromError(_: Error): State {
    return { hasError: true };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error("Uncaught error:", error, errorInfo);
  }

  public render() {
    if (this.state.hasError) {
      return (
          <div className="flex h-screen items-center justify-center flex-col p-6 text-center bg-slate-50">
              <h1 className="text-xl font-bold text-slate-800 mb-2">Something went wrong</h1>
              <p className="text-slate-500 mb-4">Please restart the app.</p>
              <button onClick={() => window.location.reload()} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">Reload</button>
          </div>
      );
    }
    return this.props.children;
  }
}

--- FILE END: src\components\common\ErrorBoundary.tsx ---


--- FILE START: src\components\common\FilterBar.tsx ---
import React, { useState, useEffect } from 'react';
import { Search, Calendar, X } from 'lucide-react';
import { useDebounce } from '../../hooks/usePaginatedData'; 

interface FilterBarProps {
  onSearch: (term: string) => void;
  onDateChange: (range: { start: string, end: string }) => void;
  searchTerm?: string;
  dateRange?: { start: string, end: string };
}

const FilterBar: React.FC<FilterBarProps> = ({ onSearch, onDateChange, searchTerm, dateRange }) => {
  const [val, setVal] = useState(searchTerm || '');
  const dbVal = useDebounce(val, 400); 

  useEffect(() => { if (dbVal !== undefined) onSearch(dbVal); }, [dbVal, onSearch]);

  const hasDateFilter = dateRange?.start || dateRange?.end;

  // Helper to handle date clearing
  const clearDates = () => {
      onDateChange && onDateChange({ start: '', end: '' });
  };

  return (
    <div className="bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-4 flex flex-col gap-3 no-print">
      {/* Search Input */}
      <div className="relative w-full">
        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <Search className="h-4 w-4 text-slate-400" />
        </div>
        <input 
          className="block w-full pl-9 pr-3 py-2.5 border border-slate-200 rounded-lg bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 focus:border-blue-500 text-sm transition-all" 
          placeholder="Search records..." 
          value={val} 
          onChange={e => setVal(e.target.value)} 
        />
        {val && (
          <button onClick={() => setVal('')} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600">
            <X size={14} />
          </button>
        )}
      </div>
      
      {/* Date Range - With Placeholder Logic */}
      <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
        <div className="flex items-center justify-center pl-1 text-slate-500">
            <Calendar size={16}/>
        </div>
        
        <div className="flex-1 flex items-center gap-2">
            <div className="relative flex-1">
                <span className="absolute top-0 left-0 text-[9px] font-bold text-slate-400 uppercase pointer-events-none">From</span>
                <input 
                  type={dateRange?.start ? "date" : "text"} 
                  onFocus={(e) => e.target.type = 'date'} 
                  onBlur={(e) => !e.target.value && (e.target.type = 'text')}
                  placeholder="DD-MM-YYYY"
                  className="w-full bg-transparent border-0 p-0 pt-3 text-xs font-bold text-slate-800 focus:ring-0 h-8 placeholder:text-slate-400"
                  value={dateRange?.start || ''} 
                  onChange={e => onDateChange && onDateChange({ ...dateRange!, start: e.target.value })}
                />
            </div>
            <div className="w-px h-6 bg-slate-300"></div>
            <div className="relative flex-1">
                <span className="absolute top-0 left-0 text-[9px] font-bold text-slate-400 uppercase pointer-events-none">To</span>
                <input 
                  type={dateRange?.end ? "date" : "text"}
                  onFocus={(e) => e.target.type = 'date'} 
                  onBlur={(e) => !e.target.value && (e.target.type = 'text')}
                  placeholder="DD-MM-YYYY"
                  className="w-full bg-transparent border-0 p-0 pt-3 text-xs font-bold text-slate-800 focus:ring-0 h-8 placeholder:text-slate-400"
                  value={dateRange?.end || ''} 
                  onChange={e => onDateChange && onDateChange({ ...dateRange!, end: e.target.value })}
                />
            </div>
        </div>
        
        {hasDateFilter && (
            <button 
                onClick={clearDates}
                className="p-1.5 bg-slate-200 rounded-full text-slate-500 hover:bg-slate-300 transition-colors"
            >
                <X size={12} />
            </button>
        )}
      </div>
    </div>
  );
};

export default FilterBar;
--- FILE END: src\components\common\FilterBar.tsx ---


--- FILE START: src\components\common\Header.tsx ---
import React from 'react';
import { Plus } from 'lucide-react';

interface HeaderProps {
  title: string;
  onAdd: () => void;
  count?: number;
}

const Header: React.FC<HeaderProps> = ({ title, onAdd, count }) => {
  return (
    <div className="flex justify-between items-center mb-4 pt-2">
        <div>
            <h1 className="text-3xl font-black text-slate-900 dark:text-white tracking-tight">{title}</h1>
            {count !== undefined && (
                <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mt-1">
                    {count} Records
                </p>
            )}
        </div>
        <button 
            onClick={onAdd} 
            className="w-12 h-12 bg-slate-900 dark:bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-xl shadow-slate-300/50 dark:shadow-none active:scale-90 transition-all"
        >
            <Plus size={24} strokeWidth={3} />
        </button>
    </div>
  );
};
export default Header;

--- FILE END: src\components\common\Header.tsx ---


--- FILE START: src\components\common\Highlighter.tsx ---
import React from 'react';

interface HighlighterProps {
  text: string;
  highlight: string;
  className?: string;
}

export const Highlighter: React.FC<HighlighterProps> = ({ text, highlight, className = '' }) => {
  if (!highlight || !text) return <span className={className}>{text}</span>;

  const parts = text.toString().split(new RegExp(`(${highlight})`, 'gi'));
  
  return (
    <span className={className}>
      {parts.map((part, i) => 
        part.toLowerCase() === highlight.toLowerCase() ? (
          <span key={i} className="bg-yellow-200 text-slate-900 rounded-sm px-0.5 shadow-sm font-bold">
            {part}
          </span>
        ) : (
          part
        )
      )}
    </span>
  );
};
--- FILE END: src\components\common\Highlighter.tsx ---


--- FILE START: src\components\common\LockScreen.tsx ---
import React, { useState, useEffect } from 'react';
import { Lock, Unlock, Fingerprint, Delete } from 'lucide-react';

interface LockScreenProps {
  pin: string;
  onUnlock: () => void;
  enableBiometrics?: boolean;
}

const LockScreen: React.FC<LockScreenProps> = ({ pin, onUnlock, enableBiometrics }) => {
  const [input, setInput] = useState('');
  const [error, setError] = useState(false);

  useEffect(() => {
    if (input.length === 4) {
      if (input === pin) {
        onUnlock();
      } else {
        setError(true);
        setTimeout(() => {
          setInput('');
          setError(false);
        }, 500);
      }
    }
  }, [input, pin, onUnlock]);

  const handleNum = (num: string) => {
    if (input.length < 4) setInput(prev => prev + num);
  };

  const handleBackspace = () => setInput(prev => prev.slice(0, -1));

  return (
    <div className="fixed inset-0 bg-slate-900 text-white z-[60] flex flex-col items-center justify-center p-8">
      <div className="mb-8 flex flex-col items-center">
        <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-600/20">
          <Lock size={32} />
        </div>
        <h1 className="text-2xl font-black">App Locked</h1>
        <p className="text-slate-400 text-sm mt-1">Enter PIN to access</p>
      </div>

      <div className="flex gap-4 mb-12">
        {[0, 1, 2, 3].map(i => (
          <div key={i} className={`w-4 h-4 rounded-full transition-all duration-300 ${i < input.length ? 'bg-blue-500 scale-110' : 'bg-slate-700'} ${error ? 'bg-red-500 animate-pulse' : ''}`} />
        ))}
      </div>

      <div className="grid grid-cols-3 gap-6 w-full max-w-xs">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
          <button key={num} onClick={() => handleNum(num.toString())} className="h-20 w-20 rounded-full bg-slate-800 hover:bg-slate-700 font-bold text-2xl flex items-center justify-center transition-all active:scale-90">
            {num}
          </button>
        ))}
        <div className="flex items-center justify-center">
           {enableBiometrics && <button className="text-blue-500"><Fingerprint size={32}/></button>}
        </div>
        <button onClick={() => handleNum('0')} className="h-20 w-20 rounded-full bg-slate-800 hover:bg-slate-700 font-bold text-2xl flex items-center justify-center transition-all active:scale-90">0</button>
        <button onClick={handleBackspace} className="h-20 w-20 rounded-full hover:bg-slate-800 flex items-center justify-center text-slate-400 transition-all active:scale-90">
           <Delete size={28}/>
        </button>
      </div>
    </div>
  );
};
export default LockScreen;

--- FILE END: src\components\common\LockScreen.tsx ---


--- FILE START: src\components\common\PullToRefresh.tsx ---
import React, { useState, useEffect, useRef } from 'react';
import { Loader2, ArrowDown } from 'lucide-react';
import { haptic } from '../../utils/haptics';

interface PullToRefreshProps {
  onRefresh: () => Promise<void> | void;
  children: React.ReactNode;
}

export const PullToRefresh: React.FC<PullToRefreshProps> = ({ onRefresh, children }) => {
  const [startY, setStartY] = useState(0);
  const [pullDistance, setPullDistance] = useState(0);
  const [refreshing, setRefreshing] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);
  const THRESHOLD = 80;

  const handleTouchStart = (e: React.TouchEvent) => {
    if (window.scrollY === 0 && !refreshing) {
      setStartY(e.touches[0].clientY);
    }
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    if (window.scrollY === 0 && startY > 0 && !refreshing) {
      const currentY = e.touches[0].clientY;
      const diff = currentY - startY;
      if (diff > 0) {
        setPullDistance(Math.min(diff * 0.5, 120)); // Resistance
      }
    }
  };

  const handleTouchEnd = async () => {
    if (pullDistance > THRESHOLD && !refreshing) {
      setRefreshing(true);
      setPullDistance(60); // Snap to loading position
      haptic.medium();
      try {
        await onRefresh();
        haptic.success();
      } finally {
        setTimeout(() => {
          setRefreshing(false);
          setPullDistance(0);
        }, 500);
      }
    } else {
      setPullDistance(0);
    }
    setStartY(0);
  };

  return (
    <div 
      ref={contentRef}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
      style={{ minHeight: 'calc(100vh - 100px)' }}
    >
      {/* Loading Indicator */}
      <div 
        className="fixed left-0 right-0 z-10 flex justify-center pointer-events-none transition-all duration-200"
        style={{ 
            top: '60px', 
            transform: `translateY(${pullDistance - 40}px)`,
            opacity: pullDistance > 0 ? 1 : 0
        }}
      >
        <div className="bg-white rounded-full p-2 shadow-lg border border-slate-100 text-blue-600">
            {refreshing ? <Loader2 className="animate-spin" size={20}/> : 
             <ArrowDown size={20} style={{ transform: `rotate(${pullDistance * 2}deg)` }} />
            }
        </div>
      </div>

      {/* Main Content */}
      <div 
        style={{ 
            transform: `translateY(${pullDistance}px)`,
            transition: pulling ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'
        }}
        className="will-change-transform"
      >
        {children}
      </div>
    </div>
  );
};

// Helper for 'pulling' state detection during render
let pulling = false;

--- FILE END: src\components\common\PullToRefresh.tsx ---


--- FILE START: src\components\common\RecycleBin.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { ArrowLeft, RefreshCw, Trash2, AlertTriangle } from 'lucide-react';
import { collection, query, where, getDocs, doc, deleteDoc, updateDoc } from 'firebase/firestore';
import { db } from '../../config/firebase';
import { useUI } from '../../context/UIContext';

interface RecycleBinProps { user: User; onBack: () => void; }

const RecycleBin: React.FC<RecycleBinProps> = ({ user, onBack }) => {
  const { showToast, confirm } = useUI();
  const [items, setItems] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchDeleted = async () => {
    setLoading(true);
    try {
        const collections = ['ledger_entries', 'transactions', 'parties', 'vehicles', 'inventory', 'expenses'];
        let allDeleted: any[] = [];
        
        for (const col of collections) {
            // Note: This requires your delete logic to set '_deleted: true' instead of hard deleting.
            // Since we implemented hard delete (deleteDoc) in previous steps, this might be empty initially.
            // This is a placeholder for future "Soft Delete" functionality.
            const q = query(collection(db, `users/${user.uid}/${col}`), where('_deleted', '==', true));
            const snap = await getDocs(q);
            snap.forEach(d => allDeleted.push({ id: d.id, ...d.data(), _col: col }));
        }
        setItems(allDeleted);
    } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  useEffect(() => { fetchDeleted(); }, [user]);

  const handleRestore = async (item: any) => {
      await updateDoc(doc(db, `users/${user.uid}/${item._col}`, item.id), { _deleted: false });
      setItems(prev => prev.filter(i => i.id !== item.id));
      showToast("Restored", "success");
  };

  const handlePermanentDelete = async (item: any) => {
      if(await confirm("Delete Forever?", "Cannot undo.")) {
          await deleteDoc(doc(db, `users/${user.uid}/${item._col}`, item.id));
          setItems(prev => prev.filter(i => i.id !== item.id));
          showToast("Deleted Permanently", "success");
      }
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pt-12 px-4">
        <div className="flex items-center gap-3 mb-6">
            <button onClick={onBack} className="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm active:scale-95"><ArrowLeft size={20} className="dark:text-white"/></button>
            <h1 className="text-2xl font-black text-slate-900 dark:text-white">Recycle Bin</h1>
        </div>
        
        {items.length === 0 ? (
            <div className="flex-1 flex flex-col items-center justify-center text-slate-400 opacity-50">
                <Trash2 size={48} className="mb-2"/>
                <p>Bin is empty</p>
            </div>
        ) : (
            <div className="space-y-3">
                {items.map(item => (
                    <div key={item.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div>
                           <div className="font-bold dark:text-white">{item.name || item.party_name || 'Unknown Item'}</div>
                           <div className="text-xs text-slate-400 uppercase">{item._col}</div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => handleRestore(item)} className="p-2 bg-green-50 text-green-600 rounded-lg"><RefreshCw size={18}/></button>
                            <button onClick={() => handlePermanentDelete(item)} className="p-2 bg-red-50 text-red-600 rounded-lg"><Trash2 size={18}/></button>
                        </div>
                    </div>
                ))}
            </div>
        )}
    </div>
  );
};
export default RecycleBin;

--- FILE END: src\components\common\RecycleBin.tsx ---


--- FILE START: src\components\common\SeoHead.tsx ---
import { useEffect } from 'react';

const SeoHead = () => {
  useEffect(() => {
    document.title = "AI Shopkeeper Ledger - Enterprise Edition";
    const style = document.createElement('style');
    style.innerHTML = `
      @media print {
        @page { size: A4; margin: 1cm; }
        html, body { height: auto !important; overflow: visible !important; background: white !important; font-size: 10pt; color: black; font-family: sans-serif; }
        .no-print, .fixed, button, input, select, textarea, .bg-slate-900, .bg-blue-600, nav { display: none !important; }
        .print-only { display: block !important; }
        #root, main, .flex-1, .h-screen { 
            position: static !important; 
            width: 100% !important; 
            height: auto !important; 
            overflow: visible !important; 
            padding: 0 !important; 
            margin: 0 !important; 
            display: block !important;
        }
        .card, .bg-white { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; margin-bottom: 10px; }
        .grid { display: block !important; }
        .grid > * { margin-bottom: 10px; break-inside: avoid; }
        h2 { border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
      }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    `;
    document.head.appendChild(style);
    return () => { document.head.removeChild(style); };
  }, []);
  return null;
};

export default SeoHead;
--- FILE END: src\components\common\SeoHead.tsx ---


--- FILE START: src\components\common\Skeleton.tsx ---
import React from 'react';

export const Skeleton = ({ className }: { className?: string }) => (
    <div className={`animate-pulse bg-slate-200 rounded ${className}`}></div>
);

export const CardSkeleton = () => (
    <div className="bg-white p-4 rounded-xl border border-slate-100 mb-3 shadow-sm">
        <div className="flex justify-between items-start mb-3">
            <div className="space-y-2 w-1/2">
                <Skeleton className="h-5 w-3/4" />
                <Skeleton className="h-3 w-1/2" />
            </div>
            <Skeleton className="h-6 w-16 rounded-full" />
        </div>
        <div className="flex justify-between items-center pt-2 border-t border-slate-50">
            <Skeleton className="h-4 w-1/3" />
            <div className="flex gap-2">
                <Skeleton className="h-8 w-8 rounded-lg" />
                <Skeleton className="h-8 w-8 rounded-lg" />
            </div>
        </div>
    </div>
);

export const RowSkeleton = () => (
    <div className="bg-white p-3 rounded-lg border border-slate-100 shadow-sm mb-2 flex items-center justify-between">
        <div className="flex items-center gap-3 w-2/3">
            <Skeleton className="h-10 w-10 rounded-full flex-shrink-0" />
            <div className="space-y-2 w-full">
                <Skeleton className="h-4 w-3/4" />
                <Skeleton className="h-3 w-1/2" />
            </div>
        </div>
        <Skeleton className="h-5 w-16" />
    </div>
);

export const LoadingStack = ({ type = 'card', count = 4 }: { type?: 'card' | 'row', count?: number }) => (
    <div className="w-full animate-in fade-in duration-500">
        {Array.from({ length: count }).map((_, i) => (
            type === 'card' ? <CardSkeleton key={i} /> : <RowSkeleton key={i} />
        ))}
    </div>
);
--- FILE END: src\components\common\Skeleton.tsx ---


--- FILE START: src\components\common\SuggestionsInput.tsx ---
import React, { useState, useRef, useEffect } from 'react';
import { List } from 'lucide-react';

interface SuggestionsInputProps {
  value: string;
  onChange: (e: any) => void;
  placeholder: string;
  list?: any[];
  displayKey?: string;
}

const SuggestionsInput: React.FC<SuggestionsInputProps> = React.memo(({ value, onChange, placeholder, list = [], displayKey = 'name' }) => {
  const [show, setShow] = useState(false);
  const ref = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (ref.current && !ref.current.contains(event.target as Node)) {
        setShow(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  return (
      <div className="relative w-full min-w-0" ref={ref}>
          <div className="flex w-full">
              <input 
                type="text" 
                placeholder={placeholder} 
                className="flex-1 min-w-0 border p-3 rounded-l-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" 
                value={value} 
                onChange={onChange}
                onFocus={() => setShow(true)} 
              />
              <button type="button" onClick={() => setShow(!show)} className="bg-slate-100 border border-l-0 px-3 rounded-r-lg hover:bg-slate-200 text-slate-500 flex-shrink-0">
                <List size={16}/>
              </button>
          </div>
          {show && list.length > 0 && (
              <div className="absolute z-50 left-0 right-0 bg-white border rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto">
                  {list.map((item: any, i: number) => (
                      <div key={i} onClick={() => { 
                          onChange({ target: { value: item[displayKey] } }); 
                          setShow(false); 
                      }} className="p-3 hover:bg-blue-50 cursor-pointer text-sm border-b last:border-0 text-slate-700">
                          {item[displayKey]}
                      </div>
                  ))}
              </div>
          )}
      </div>
  );
});

export default SuggestionsInput;
--- FILE END: src\components\common\SuggestionsInput.tsx ---


--- FILE START: src\components\common\Toast.tsx ---
import React, { useEffect } from 'react';
import { X, CheckCircle, AlertCircle, Info } from 'lucide-react';

export type ToastType = 'success' | 'error' | 'info';

interface ToastProps {
  id: string;
  message: string;
  type: ToastType;
  onClose: (id: string) => void;
  actionLabel?: string;     // New Prop
  onAction?: () => void;    // New Prop
}

const Toast: React.FC<ToastProps> = ({ id, message, type, onClose, actionLabel, onAction }) => {
  useEffect(() => {
    // Longer timeout if there is an action button
    const duration = actionLabel ? 6000 : 3000;
    const timer = setTimeout(() => onClose(id), duration); 
    return () => clearTimeout(timer);
  }, [id, onClose, actionLabel]);

  const bg = {
    success: 'bg-green-50 border-green-200 text-green-800',
    error: 'bg-red-50 border-red-200 text-red-800',
    info: 'bg-blue-50 border-blue-200 text-blue-800'
  }[type];

  const Icon = {
    success: CheckCircle,
    error: AlertCircle,
    info: Info
  }[type];

  return (
    <div className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border min-w-[300px] animate-in slide-in-from-top-2 fade-in duration-300 ${bg}`}>
      <Icon size={20} />
      <span className="flex-1 text-sm font-medium">{message}</span>
      
      {/* New Action Button */}
      {actionLabel && onAction && (
          <button 
            onClick={() => { onAction(); onClose(id); }}
            className="px-3 py-1 bg-white/50 hover:bg-white/80 rounded border border-transparent hover:border-black/10 text-xs font-bold uppercase transition-colors"
          >
            {actionLabel}
          </button>
      )}

      <button onClick={() => onClose(id)} className="opacity-70 hover:opacity-100"><X size={16} /></button>
    </div>
  );
};

export default Toast;
--- FILE END: src\components\common\Toast.tsx ---


--- FILE START: src\components\common\TopNavigation.tsx ---
import React, { useState, useEffect } from 'react';
import { Menu, Mic, Cloud, CloudOff, Wifi, WifiOff } from 'lucide-react';
import { useUI } from '../../context/UIContext';

interface TopNavigationProps {
  activeTab: string;
  setActiveTab: (tab: string) => void;
  openCommandCenter: () => void;
}

const TopNavigation: React.FC<TopNavigationProps> = ({ activeTab, setActiveTab, openCommandCenter }) => {
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return (
    <div className="bg-white px-4 py-3 flex justify-between items-center shadow-sm sticky top-0 z-50 safe-area-top">
      <div className="flex items-center gap-3">
        {/* LOGO / MENU */}
        <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
          S
        </div>
        
        {/* SYNC INDICATOR */}
        <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded-full ${isOnline ? 'bg-green-50 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
           {isOnline ? <Cloud size={12} /> : <CloudOff size={12} />}
           {isOnline ? 'Synced' : 'Offline'}
        </div>
      </div>

      <h1 className="font-bold text-lg capitalize text-slate-800 absolute left-1/2 -translate-x-1/2">
        {activeTab.replace('-', ' ')}
      </h1>

      <button 
        onClick={openCommandCenter}
        className="w-10 h-10 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-all"
      >
        <Mic size={20} />
      </button>
    </div>
  );
};

export default TopNavigation;
--- FILE END: src\components\common\TopNavigation.tsx ---


--- FILE START: src\components\modals\CommandModal.tsx ---
import React, { useState, useEffect, useRef } from 'react';
import { User } from 'firebase/auth';
import { 
  X, Loader2, UploadCloud, CheckCircle2, ArrowRight, 
  AlertTriangle, Image as ImageIcon, FileAudio, Maximize2, Minimize2, Trash2, Edit2, Save
} from 'lucide-react';
import { haptic } from '../../utils/haptics';
import { ApiService } from '../../services/api';
import { GeminiService } from '../../services/gemini';
import { AppSettings } from '../../types';
import { collection, query, where, getDocs } from 'firebase/firestore'; 
import { db } from '../../config/firebase'; 

interface CommandModalProps {
  isOpen: boolean;
  onClose: () => void;
  user: User | null;
  onSuccess?: () => void;
  appSettings?: AppSettings; // Added AppSettings Prop
}

const CommandModal: React.FC<CommandModalProps> = ({ isOpen, onClose, user, onSuccess, appSettings }) => {
  const [transcript, setTranscript] = useState('');
  const [processing, setProcessing] = useState(false);
  const [scannedData, setScannedData] = useState<any[] | null>(null);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [preview, setPreview] = useState<string | null>(null);
  const [errorMsg, setErrorMsg] = useState('');
  const [isExpanded, setIsExpanded] = useState(false);
  
  const [editingIndex, setEditingIndex] = useState<number | null>(null);
  const [editForm, setEditForm] = useState<any>({});

  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (isOpen) {
        setTranscript('');
        setErrorMsg('');
        setScannedData(null);
        setSelectedFile(null);
        setPreview(null);
        setIsExpanded(false);
        setEditingIndex(null);
        setEditForm({});
    }
  }, [isOpen]);

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
      if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          setSelectedFile(file);
          if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onloadend = () => setPreview(reader.result as string);
              reader.readAsDataURL(file);
          } else {
              setPreview(null); 
          }
          haptic.selection();
      }
  };

  const processInput = async () => {
      if ((!transcript && !selectedFile) || !user) return;
      setProcessing(true);
      setErrorMsg('');

      try {
          const isAudio = selectedFile?.type.startsWith('audio/');
          const isImage = selectedFile?.type.startsWith('image/');
          
          const data = await GeminiService.processInput(
              transcript, 
              isImage ? selectedFile : null,
              isAudio ? selectedFile : null
          );
          
          if (!data || data.length === 0) throw new Error("Could not understand command.");
          setScannedData(data);
          haptic.success();
      } catch (e: any) {
          setErrorMsg(e.message || "Failed to process.");
          haptic.error();
      } finally {
          setProcessing(false);
      }
  };

  const deleteItem = (index: number) => {
      if (!scannedData) return;
      const newData = scannedData.filter((_, i) => i !== index);
      setScannedData(newData.length > 0 ? newData : null);
      haptic.medium();
  };

  const startEditing = (index: number, item: any) => {
      setEditingIndex(index);
      setEditForm({ ...item });
      haptic.selection();
  };

  const saveEdit = () => {
      if (!scannedData || editingIndex === null) return;
      const newData = [...scannedData];
      const updatedItem = { ...editForm };
      
      if (updatedItem.amount) updatedItem.amount = Number(updatedItem.amount);
      if (updatedItem.total_amount) updatedItem.total_amount = Number(updatedItem.total_amount);
      
      if (updatedItem.items && Array.isArray(updatedItem.items)) {
          updatedItem.items = updatedItem.items.map((i: any) => ({
              ...i,
              total: (Number(i.quantity)||0) * (Number(i.rate)||0)
          }));
          updatedItem.total_amount = updatedItem.items.reduce((sum: number, i: any) => sum + i.total, 0);
      }

      newData[editingIndex] = updatedItem;
      setScannedData(newData);
      setEditingIndex(null);
      setEditForm({});
      haptic.success();
  };

  const executeSave = async () => {
      if (!scannedData || !user) return;
      haptic.medium();
      setProcessing(true);
      setErrorMsg('');

      try {
          for (const item of scannedData) {
              const collectionName = item.collection;
              if (!collectionName) continue;
              const { collection: _, ...payload } = item;

              // --- CRITICAL SAFETY CHECK: INVENTORY STOCK ---
              if (collectionName === 'ledger_entries' && payload.type === 'sell' && payload.items) {
                  for (const lineItem of payload.items) {
                      const q = query(collection(db, `users/${user.uid}/inventory`), where('name', '==', lineItem.item_name));
                      const snap = await getDocs(q);
                      
                      if (!snap.empty) {
                          const stockData = snap.docs[0].data() as any;
                          const currentStock = Number(stockData.current_stock) || 0;
                          const reqQty = Number(lineItem.quantity) || 0;

                          if (reqQty > currentStock) {
                              const allowNegative = appSettings?.automation?.allow_negative_stock;
                              
                              if (!allowNegative) {
                                  // STRICT BLOCK
                                  throw new Error(`Insufficient Stock for ${lineItem.item_name}. Available: ${currentStock}. Enable 'Allow Low Stock' in settings to override.`);
                              } else {
                                  // ALLOW BUT WARN
                                  console.warn(`Low stock warning for ${lineItem.item_name}`);
                              }
                          }
                      }
                  }
              }

              await ApiService.add(user.uid, collectionName, payload);
          }
          
          haptic.success();
          if (onSuccess) onSuccess();
          onClose();
      } catch (e: any) {
          setErrorMsg(e.message); 
          haptic.error();
      } finally {
          setProcessing(false);
      }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/90 z-[100] flex flex-col justify-end sm:justify-center p-0 sm:p-4 animate-in fade-in duration-200">
        <div className={`bg-white w-full sm:w-[550px] sm:mx-auto rounded-t-3xl sm:rounded-3xl p-6 flex flex-col relative transition-all duration-300 ${isExpanded ? 'h-[90vh]' : 'max-h-[85vh] h-auto'}`}>
            
            {/* Header */}
            <div className="flex justify-between items-center mb-6 flex-none">
                <div>
                    <h2 className="text-2xl font-bold text-slate-900">AI Command Center</h2>
                    <p className="text-xs text-slate-500">Type, or Upload Image/Audio</p>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setIsExpanded(!isExpanded)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                        {isExpanded ? <Minimize2 size={20}/> : <Maximize2 size={20}/>}
                    </button>
                    <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X size={20}/></button>
                </div>
            </div>

            {errorMsg && (
                <div className="mb-4 p-3 bg-red-50 text-red-600 text-xs rounded-lg flex items-center gap-2 font-bold animate-pulse flex-none">
                    <AlertTriangle size={16}/> {errorMsg}
                </div>
            )}

            {/* Content Area */}
            <div className="flex-1 overflow-y-auto mb-4 scrollbar-hide">
                {scannedData ? (
                    <div className="space-y-3">
                        <div className="text-sm font-bold text-green-700 bg-green-50 p-2 rounded flex items-center gap-2">
                            <CheckCircle2 size={16}/> Ready to Save ({scannedData.length})
                        </div>
                        
                        {scannedData.map((item, idx) => (
                            <div key={idx} className="border border-slate-200 rounded-xl p-3 bg-slate-50 text-sm relative group">
                                {editingIndex === idx ? (
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold text-blue-600">Editing Record</span>
                                            <button onClick={saveEdit} className="p-1 bg-green-100 text-green-700 rounded hover:bg-green-200"><Save size={16}/></button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {item.party_name !== undefined && <input className="border p-1 rounded" placeholder="Name" value={editForm.party_name} onChange={e => setEditForm({...editForm, party_name: e.target.value})} />}
                                            {item.amount !== undefined && <input type="number" className="border p-1 rounded" placeholder="Amount" value={editForm.amount} onChange={e => setEditForm({...editForm, amount: e.target.value})} />}
                                            {item.vehicle !== undefined && <input className="border p-1 rounded" placeholder="Vehicle" value={editForm.vehicle} onChange={e => setEditForm({...editForm, vehicle: e.target.value})} />}
                                            {item.vehicle_rent !== undefined && <input type="number" className="border p-1 rounded" placeholder="Rent" value={editForm.vehicle_rent} onChange={e => setEditForm({...editForm, vehicle_rent: e.target.value})} />}
                                        </div>
                                        {editForm.items && Array.isArray(editForm.items) && (
                                            <div className="bg-white p-2 rounded border mt-2">
                                                {editForm.items.map((it: any, k: number) => (
                                                    <div key={k} className="flex gap-1 mb-1">
                                                        <input className="w-12 border rounded text-center" value={it.quantity} onChange={e => {
                                                            const newItems = [...editForm.items];
                                                            newItems[k].quantity = e.target.value;
                                                            setEditForm({...editForm, items: newItems});
                                                        }} />
                                                        <input className="flex-1 border rounded px-1" value={it.item_name} onChange={e => {
                                                            const newItems = [...editForm.items];
                                                            newItems[k].item_name = e.target.value;
                                                            setEditForm({...editForm, items: newItems});
                                                        }} />
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <>
                                        <div className="absolute top-2 right-2 flex gap-1">
                                            <button onClick={() => startEditing(idx, item)} className="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"><Edit2 size={14}/></button>
                                            <button onClick={() => deleteItem(idx)} className="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100"><Trash2 size={14}/></button>
                                        </div>
                                        <div className="flex justify-between items-start pr-16">
                                            <span className="font-bold text-slate-700 uppercase text-[10px] bg-slate-200 px-1.5 py-0.5 rounded tracking-wider">{item.collection}</span>
                                            {(item.total_amount > 0 || item.amount > 0) && <span className="font-bold text-slate-900">{item.total_amount || item.amount}</span>}
                                        </div>
                                        <div className="mt-1 font-medium text-slate-800">
                                            {item.party_name || item.name || item.category || 'Record'} 
                                            {item.vehicle && <span className="ml-2 text-slate-500 text-xs bg-white border px-1 rounded"> {item.vehicle}</span>}
                                        </div>
                                        {item.items && (
                                            <div className="text-xs text-slate-500 mt-1 pl-2 border-l-2 border-slate-300">
                                                {item.items.map((i:any, k:number) => <div key={k}>{i.quantity} {i.unit} {i.item_name}</div>)}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="space-y-4">
                        {preview && <div className="relative h-48 w-full rounded-xl overflow-hidden border border-slate-200 bg-slate-100 flex-none"><img src={preview} className="w-full h-full object-contain" alt="Preview" /><button onClick={() => { setSelectedFile(null); setPreview(null); }} className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"><X size={14}/></button></div>}
                        {selectedFile && !preview && <div className="bg-blue-50 p-4 rounded-xl text-blue-600 font-bold flex items-center justify-between flex-none"><div className="flex items-center gap-3"><FileAudio size={24}/> <div className="text-sm truncate max-w-[200px]">{selectedFile.name}</div></div><button onClick={() => setSelectedFile(null)} className="text-blue-400 hover:text-blue-700"><X size={18}/></button></div>}
                        <textarea className={`w-full bg-slate-50 p-4 rounded-xl border border-slate-200 font-medium outline-none resize-none focus:ring-2 focus:ring-blue-500 transition-all ${isExpanded ? 'flex-1 min-h-[300px]' : 'h-32'}`} placeholder="e.g. Sold 200 cement to Amit, Vehicle UP70 AB 1234..." value={transcript} onChange={(e) => setTranscript(e.target.value)} />
                        <input type="file" accept="image/*,audio/*" ref={fileInputRef} className="hidden" onChange={handleFileSelect} />
                        <button onClick={() => fileInputRef.current?.click()} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold hover:bg-slate-50 hover:border-slate-400 transition-all flex items-center justify-center gap-2 flex-none"><UploadCloud size={20}/> Upload Image (OCR) or Audio</button>
                    </div>
                )}
            </div>

            <div className="flex gap-3 pt-4 border-t border-slate-50 flex-none">
                {scannedData ? (
                    <>
                        <button onClick={() => setScannedData(null)} className="px-6 py-4 rounded-xl font-bold text-slate-600 border border-slate-200">Back</button>
                        <button onClick={executeSave} disabled={processing} className="flex-1 bg-green-600 text-white rounded-xl font-bold text-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all py-4">
                            {processing ? <Loader2 className="animate-spin"/> : <CheckCircle2 size={24}/>} Confirm Save
                        </button>
                    </>
                ) : (
                    <button onClick={processInput} disabled={(!transcript && !selectedFile) || processing} className="flex-1 bg-slate-900 text-white rounded-xl font-bold text-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all py-4">
                        {processing ? <Loader2 className="animate-spin"/> : <ArrowRight size={24}/>} Process Command
                    </button>
                )}
            </div>
        </div>
    </div>
  );
};
export default CommandModal;

--- FILE END: src\components\modals\CommandModal.tsx ---


--- FILE START: src\components\modals\ManualEntryModal.tsx ---
import React, { useState, useEffect, useRef } from 'react';
import { User } from 'firebase/auth';
import { 
  X, Save, Plus, Trash2, Calendar, Truck, User as UserIcon, 
  Package, Hash, MapPin, Phone, FileText, IndianRupee, AlertOctagon,
  Percent, Tag, UserCheck, Briefcase, Wallet
} from 'lucide-react';
import { ApiService } from '../../services/api';
import { Sanitizer } from '../../services/sanitizer'; 
import { AppSettings } from '../../types';
import { haptic } from '../../utils/haptics';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '../../config/firebase'; 
import { useUI } from '../../context/UIContext'; 

interface ManualEntryModalProps {
  isOpen: boolean;
  onClose: () => void;
  type: string;
  user: User | null;
  initialData?: any;
  appSettings: AppSettings;
  onUpdateSettings?: (s: AppSettings) => void;
  onSuccess?: (data: any) => void;
}

const AutoComplete = ({ label, value, onChange, options, icon: Icon, placeholder = '' }: any) => {
    const [showSuggestions, setShowSuggestions] = useState(false);
    const wrapperRef = useRef<any>(null);
    const safeOptions = Array.isArray(options) ? options : [];
    const safeValue = Sanitizer.asString(value);

    useEffect(() => {
        const handleClickOutside = (event: any) => {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false);
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const filtered = safeOptions.filter((opt: string) => 
        Sanitizer.asString(opt).toLowerCase().includes(safeValue.toLowerCase())
    );

    return (
        <div className="mb-3 relative" ref={wrapperRef}>
            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 flex items-center gap-1">{Icon && <Icon size={12}/>} {label}</label>
            <input className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none"
                value={safeValue} 
                onChange={(e) => { onChange(e.target.value); setShowSuggestions(true); }} 
                onFocus={() => setShowSuggestions(true)} 
                placeholder={placeholder} 
            />
            {showSuggestions && filtered.length > 0 && (
                <div className="absolute z-50 w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto">
                    {filtered.map((opt: string, i: number) => (
                        <div key={i} className="p-2 text-sm hover:bg-blue-50 dark:hover:bg-slate-700 cursor-pointer text-slate-700 dark:text-slate-200" onClick={() => { onChange(opt); setShowSuggestions(false); }}>{opt}</div>
                    ))}
                </div>
            )}
        </div>
    );
};

const InputField = ({ label, field, type='text', icon: Icon, placeholder, value, onChange, disabled }: any) => (
    <div className="mb-3">
        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 flex items-center gap-1">{Icon && <Icon size={12}/>} {label}</label>
        <input className={`w-full border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 text-sm font-medium outline-none focus:ring-2 focus:ring-blue-500 ${disabled ? 'bg-slate-100 dark:bg-slate-900 text-slate-400' : 'bg-slate-50 dark:bg-slate-800 dark:text-white'}`}
            type={type} 
            value={Sanitizer.asString(value)} 
            onChange={e => onChange(field, e.target.value)} 
            placeholder={placeholder} 
            disabled={disabled} 
        />
    </div>
);

const ManualEntryModal: React.FC<ManualEntryModalProps> = ({ isOpen, onClose, type, user, initialData, appSettings, onSuccess, onUpdateSettings }) => {
  const { showToast } = useUI();
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState<any>({});
  const [items, setItems] = useState<any[]>([{ item_name: '', quantity: '', rate: '', unit: 'Pcs', total: 0, hsn_code: '', gst_percent: 0 }]);
  
  // Lists
  const [customers, setCustomers] = useState<string[]>([]);
  const [suppliers, setSuppliers] = useState<string[]>([]);
  const [vehicles, setVehicles] = useState<string[]>([]);
  const [fullInventory, setFullInventory] = useState<any[]>([]); 
  const [itemList, setItemList] = useState<string[]>([]);
  
  const expenseTypes = appSettings.custom_lists?.expense_types || [];
  const paymentModes = appSettings.custom_lists?.payment_modes || [];
  const receivedByList = appSettings.custom_lists?.received_by_names || [];
  const paidByList = appSettings.custom_lists?.paid_by_names || [];
  const purposes = appSettings.custom_lists?.purposes || [];

  const visibility = appSettings.field_visibility || {};
  const [creditAlert, setCreditAlert] = useState<string>('');
  const isEditMode = !!initialData?.id;

  useEffect(() => {
    if (isOpen && user) {
        const fetchData = async () => {
            try {
                const [pSnap, vSnap, iSnap] = await Promise.all([
                    ApiService.getAll(user.uid, 'parties'),
                    ApiService.getAll(user.uid, 'vehicles'),
                    ApiService.getAll(user.uid, 'inventory')
                ]);
                const pData = pSnap.docs.map(d => d.data());
                setCustomers(Sanitizer.cleanList(pData.filter((p: any) => p.role === 'customer').map((p: any) => p.name)));
                setSuppliers(Sanitizer.cleanList(pData.filter((p: any) => p.role === 'supplier').map((p: any) => p.name)));
                setVehicles(Sanitizer.cleanList(vSnap.docs.map(d => d.data().vehicle_number)));
                
                const iData = iSnap.docs.map(d => d.data());
                setFullInventory(iData);
                setItemList(Sanitizer.cleanList(iData.map((d: any) => d.name)));
            } catch (e) { console.error(e); }
        };
        fetchData();

        if (initialData) {
            setFormData({ ...initialData });
            if (initialData.items) setItems(initialData.items);
        } else {
            const defaults: any = { date: new Date().toISOString().split('T')[0] };
            if (type === 'sales') { defaults.payment_mode = 'Credit'; defaults.payment_received_by = 'Owner'; }
            if (type === 'purchases') { defaults.paid_by = 'Owner'; }
            if (type === 'transactions') { defaults.type = 'received'; defaults.payment_mode = 'Cash'; }
            if (type === 'inventory') { defaults.gst_percent = 18; defaults.price_type = 'exclusive'; }
            setFormData(defaults);
        }
    }
  }, [isOpen, initialData, type, user]);

  const handleChange = (field: string, value: any) => setFormData((prev: any) => ({ ...prev, [field]: value }));
  
  const handleItemChange = (index: number, field: string, value: any) => {
      const newItems = [...items];
      newItems[index][field] = value;
      if (field === 'item_name') {
          const matchedItem = fullInventory.find(i => i.name === value);
          if (matchedItem) {
              newItems[index].hsn_code = matchedItem.hsn_code || '';
              newItems[index].gst_percent = matchedItem.gst_percent || 0;
              newItems[index].unit = matchedItem.unit || 'Pcs';
              if (type === 'sales' && matchedItem.sale_rate) newItems[index].rate = matchedItem.sale_rate;
              if (type === 'purchases' && matchedItem.purchase_rate) newItems[index].rate = matchedItem.purchase_rate;
          }
      }
      if (field === 'quantity' || field === 'rate') {
          newItems[index].total = (Number(newItems[index].quantity)||0) * (Number(newItems[index].rate)||0);
      }
      setItems(newItems);
  };
  
  const calculateGrandTotal = () => items.reduce((sum, item) => sum + (Number(item.total) || 0), 0);

  const handleSubmit = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!user) return;
      setLoading(true);
      haptic.medium();
      try {
          const payload = { ...formData };
          let targetCollection = '';
          
          if (type === 'sales' || type === 'purchases') {
              targetCollection = 'ledger_entries';
              payload.type = type === 'sales' ? 'sell' : 'purchase';
              payload.items = items;
              payload.total_amount = calculateGrandTotal();
          } 
          else if (type === 'transactions') targetCollection = 'transactions';
          else if (type === 'inventory') targetCollection = 'inventory';
          else if (type === 'expenses') targetCollection = 'expenses';

          if (!targetCollection) return;

          if (initialData?.id) await ApiService.update(user.uid, targetCollection, initialData.id, payload);
          else { payload.created_at = new Date().toISOString(); await ApiService.add(user.uid, targetCollection, payload); }
          
          if (onSuccess) onSuccess(payload);
          onClose();
          haptic.success();
      } catch (e) { console.error(e); showToast("Error saving record.", "error"); haptic.error(); } finally { setLoading(false); }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/80 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4 animate-in fade-in duration-200 backdrop-blur-sm">
        <div className="bg-white dark:bg-slate-900 w-full sm:w-[600px] rounded-t-3xl sm:rounded-2xl max-h-[90vh] flex flex-col shadow-2xl safe-area-bottom border border-slate-100 dark:border-slate-800">
            <div className="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950 rounded-t-3xl">
                <h2 className="font-bold text-lg capitalize flex items-center gap-2 dark:text-white">{initialData ? 'Edit' : 'New'} {type.replace('_', ' ')}</h2>
                <button onClick={onClose} className="p-2 bg-white dark:bg-slate-800 rounded-full border dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white"><X size={18}/></button>
            </div>

            <div className="flex-1 overflow-y-auto p-5 space-y-5">
                <form id="entry-form" onSubmit={handleSubmit}>
                    {/* TRANSACTIONS */}
                    {type === 'transactions' && (
                        <>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Type</label>
                                    <div className="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
                                        <button type="button" onClick={() => handleChange('type', 'received')} className={`flex-1 py-2 rounded-md text-sm font-bold ${formData.type === 'received' ? 'bg-white dark:bg-slate-700 shadow text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-slate-400'}`}>Received</button>
                                        <button type="button" onClick={() => handleChange('type', 'paid')} className={`flex-1 py-2 rounded-md text-sm font-bold ${formData.type === 'paid' ? 'bg-white dark:bg-slate-700 shadow text-red-600 dark:text-red-400' : 'text-slate-500 dark:text-slate-400'}`}>Paid</button>
                                    </div>
                                </div>
                                <InputField label="Date" field="date" type="date" icon={Calendar} value={formData.date} onChange={handleChange} />
                            </div>
                            <AutoComplete label={formData.type === 'received' ? "Customer Name" : "Supplier Name"} value={formData.party_name || ''} onChange={(v: string) => handleChange('party_name', v)} options={formData.type === 'received' ? customers : suppliers} icon={UserIcon} />
                            <InputField label="Amount" field="amount" type="number" icon={IndianRupee} value={formData.amount} onChange={handleChange} />
                            <div className="grid grid-cols-2 gap-4">
                                <div className="mb-3">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Payment Mode</label>
                                    <select className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 p-2.5 rounded-lg text-sm" value={formData.payment_mode || ''} onChange={e => handleChange('payment_mode', e.target.value)}>{paymentModes.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                </div>
                                {formData.type === 'received' ? (visibility.transactions?.received_by && <InputField label="Received By" field="received_by" value={formData.received_by} onChange={handleChange} />) : (visibility.transactions?.paid_by && <InputField label="Paid By" field="paid_by" value={formData.paid_by} onChange={handleChange} />)}
                            </div>
                            {visibility.transactions?.notes && <InputField label="Notes" field="notes" value={formData.notes} onChange={handleChange} />}
                        </>
                    )}

                    {/* SALES / PURCHASES */}
                    {(type === 'sales' || type === 'purchases') && (
                        <>
                           <div className="grid grid-cols-3 gap-3">
                               <div className="col-span-1"><InputField label="Date" field="date" type="date" icon={Calendar} value={formData.date} onChange={handleChange} /></div>
                               <div className="col-span-2">{visibility.ledger?.invoice_no && <InputField label="Invoice No" field="invoice_no" icon={Hash} value={formData.invoice_no} onChange={handleChange} />}</div>
                           </div>
                           <AutoComplete label={type === 'sales' ? "Customer" : "Supplier"} value={formData.party_name || ''} onChange={(v: string) => handleChange('party_name', v)} options={type === 'sales' ? customers : suppliers} icon={UserIcon} />
                           
                           <div className="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                               <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 block">Items</label>
                               {items.map((item, idx) => (
                                   <div key={idx} className="mb-3 pb-3 border-b border-slate-200 dark:border-slate-700 last:border-0 last:pb-0">
                                       <div className="flex gap-2 mb-2">
                                           <div className="flex-[2]"><AutoComplete label="" value={item.item_name} onChange={(v: string) => handleItemChange(idx, 'item_name', v)} options={itemList} placeholder="Item Name" /></div>
                                           <input className="w-16 p-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded h-[42px]" placeholder="Unit" value={item.unit} onChange={e => handleItemChange(idx, 'unit', e.target.value)} />
                                       </div>
                                       <div className="flex gap-2 items-center">
                                           <input className="flex-1 p-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded min-w-[60px]" type="number" placeholder="Qty" value={item.quantity} onChange={e => handleItemChange(idx, 'quantity', e.target.value)} />
                                           <span className="text-slate-400">x</span>
                                           <input className="flex-1 p-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded min-w-[60px]" type="number" placeholder="Rate" value={item.rate} onChange={e => handleItemChange(idx, 'rate', e.target.value)} />
                                           <div className="flex-1 font-bold text-right text-sm dark:text-white">{item.total}</div>
                                           <button type="button" onClick={() => { if(items.length>1) setItems(items.filter((_, i) => i !== idx)) }} className="p-2 text-red-500"><Trash2 size={16}/></button>
                                       </div>
                                   </div>
                               ))}
                               <button type="button" onClick={() => setItems([...items, { item_name: '', quantity: '', rate: '', unit: 'Pcs', total: 0 }])} className="w-full py-2 bg-white dark:bg-slate-700 border border-dashed border-slate-300 dark:border-slate-600 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-300 flex items-center justify-center gap-2 hover:bg-blue-50 dark:hover:bg-slate-600"><Plus size={14}/> Add Item</button>
                           </div>
                           {visibility.ledger?.notes && <InputField label="Notes" field="notes" value={formData.notes} onChange={handleChange} />}
                        </>
                    )}

                    {/* INVENTORY */}
                    {type === 'inventory' && (
                        <>
                             <InputField label="Item Name" field="name" icon={Package} value={formData.name} onChange={handleChange} />
                             <div className="grid grid-cols-2 gap-3"><InputField label="Unit" field="unit" placeholder="Pcs/Kg" value={formData.unit} onChange={handleChange} />{visibility.inventory?.hsn_code && <InputField label="HSN Code" field="hsn_code" icon={Hash} value={formData.hsn_code} onChange={handleChange} />}</div>
                             <div className="grid grid-cols-2 gap-3"><InputField label="Sell Rate" field="sale_rate" type="number" icon={IndianRupee} value={formData.sale_rate} onChange={handleChange} /><InputField label="Purchase Rate" field="purchase_rate" type="number" icon={IndianRupee} value={formData.purchase_rate} onChange={handleChange} /></div>
                             <InputField label="Current Stock" field="current_stock" type="number" value={formData.current_stock} onChange={handleChange} />
                        </>
                    )}

                    {/* EXPENSES */}
                    {type === 'expenses' && (
                        <>
                            <InputField label="Date" field="date" type="date" value={formData.date} onChange={handleChange} />
                            <div className="mb-3"><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Category</label><select className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white border dark:border-slate-700 p-2.5 rounded-lg text-sm" value={formData.category || ''} onChange={e => handleChange('category', e.target.value)}>{expenseTypes.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                            <InputField label="Amount" field="amount" type="number" icon={IndianRupee} value={formData.amount} onChange={handleChange} />
                            <InputField label="Note" field="notes" value={formData.notes} onChange={handleChange} />
                        </>
                    )}
                </form>
            </div>

            <div className="p-4 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-950 rounded-b-2xl pb-8 md:pb-4">
                <button type="submit" form="entry-form" disabled={loading} className="w-full bg-slate-900 dark:bg-blue-600 text-white py-3.5 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all">
                    {loading ? 'Saving...' : <><Save size={20}/> Save Record</>}
                </button>
            </div>
        </div>
    </div>
  );
};
export default ManualEntryModal;

--- FILE END: src\components\modals\ManualEntryModal.tsx ---


--- FILE START: src\components\views\AuthView.tsx ---
import React, { useState } from 'react';
import { 
  signInWithPopup, 
  GoogleAuthProvider, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword 
} from 'firebase/auth';
import { auth } from '../../config/firebase';
import { ShieldCheck, LogIn, UserPlus, AlertCircle, Loader2 } from 'lucide-react';

const AuthView = () => {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleGoogle = async () => {
    try {
      setLoading(true);
      setError('');
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      await signInWithPopup(auth, provider);
    } catch (err: any) {
      console.error(err);
      if (err.code !== 'auth/popup-closed-by-user') {
          setError(err.message || "Google Sign-In failed.");
      }
    } finally {
      setLoading(false);
    }
  };

  const handleEmail = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!email || !password) { setError("Please fill all fields"); return; }
    try {
      setLoading(true);
      setError('');
      if (isLogin) await signInWithEmailAndPassword(auth, email, password);
      else await createUserWithEmailAndPassword(auth, email, password);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 relative safe-area-bottom">
      <div className="bg-white w-full max-w-sm rounded-3xl shadow-xl p-8 z-10">
        <div className="flex justify-center mb-6">
          <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200">
             <ShieldCheck className="text-white" size={32} />
          </div>
        </div>
        <h1 className="text-2xl font-bold text-center text-slate-900 mb-2">{isLogin ? 'Welcome Back' : 'Create Account'}</h1>
        <p className="text-center text-slate-500 mb-8 text-sm">Secure Cloud Ledger for Shopkeepers</p>

        {error && <div className="bg-red-50 text-red-600 p-3 rounded-xl text-sm font-medium mb-6 flex items-center gap-2 animate-in slide-in-from-top-2"><AlertCircle size={16} /> {error}</div>}

        <form onSubmit={handleEmail} className="space-y-4">
          <div>
            <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Email</label>
            <input type="email" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="name@example.com" value={email} onChange={e => setEmail(e.target.value)}/>
          </div>
          <div>
            <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Password</label>
            <input type="password" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="" value={password} onChange={e => setPassword(e.target.value)}/>
          </div>
          <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 hover:bg-slate-800">
            {loading ? <Loader2 className="animate-spin" /> : (isLogin ? <LogIn size={18}/> : <UserPlus size={18}/>)} {isLogin ? 'Sign In' : 'Create Account'}
          </button>
        </form>

        <div className="relative my-8"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400 font-bold">Or continue with</span></div></div>

        <button onClick={handleGoogle} disabled={loading} className="w-full bg-white border border-slate-200 text-slate-700 py-3.5 rounded-xl font-bold text-sm shadow-sm hover:bg-slate-50 active:scale-95 transition-all flex items-center justify-center gap-2">
          {loading ? <Loader2 className="animate-spin text-slate-400"/> : <img src="https://www.google.com/favicon.ico" className="w-4 h-4" alt="G"/>} Sign in with Google
        </button>

        <p className="text-center mt-8 text-sm text-slate-500">{isLogin ? "Don't have an account?" : "Already have an account?"} <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 font-bold ml-1 hover:underline">{isLogin ? 'Sign Up' : 'Log In'}</button></p>
      </div>
      
      {/* Copyright Footer - NOW INSIDE THE VIEW */}
      <div className="mt-8 text-slate-400 text-xs font-bold">
         &copy; Prayagraj Associates
      </div>
    </div>
  );
};
export default AuthView;

--- FILE END: src\components\views\AuthView.tsx ---


--- FILE START: src\components\views\Dashboard.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { 
  TrendingUp, TrendingDown, Package, Users, 
  ShoppingCart, AlertTriangle, Clock, ArrowRight, Plus 
} from 'lucide-react';
import { ApiService } from '../../services/api';
import { haptic } from '../../utils/haptics';

interface DashboardProps {
  user: User;
  onQuickAction: (type: string) => void;
}

const Dashboard: React.FC<DashboardProps> = ({ user, onQuickAction }) => {
  const [stats, setStats] = useState({
    todaySale: 0,
    monthSale: 0,
    lowStock: 0,
    receivable: 0,
    payable: 0
  });
  const [recentActivity, setRecentActivity] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadDashboard = async () => {
      try {
        setLoading(true);
        const todayStr = new Date().toISOString().split('T')[0];
        const currentMonth = todayStr.substring(0, 7); // YYYY-MM

        // 1. Fetch ALL Data (Safe Strategy - Avoids Index Errors)
        const [ledgerSnap, invSnap, partySnap] = await Promise.all([
            ApiService.getAll(user.uid, 'ledger_entries'),
            ApiService.getAll(user.uid, 'inventory'),
            ApiService.getAll(user.uid, 'parties')
        ]);

        let today = 0;
        let month = 0;
        let low = 0;
        let recv = 0;
        let pay = 0;
        const activity: any[] = [];

        // 2. Calculate Sales
        ledgerSnap.forEach(doc => {
            const d = doc.data();
            activity.push({ id: doc.id, ...d, _sortDate: d.date || '' });
            
            if (d.type === 'sell') {
                const amount = Number(d.total_amount) || 0;
                if (d.date === todayStr) today += amount;
                if (d.date && d.date.startsWith(currentMonth)) month += amount;
            }
        });

        // 3. Calculate Stock
        invSnap.forEach(doc => {
            const d = doc.data();
            if ((Number(d.current_stock) || 0) <= (Number(d.min_stock) || 5)) {
                low++;
            }
        });

        // 4. Calculate Parties
        partySnap.forEach(doc => {
            const d = doc.data();
            const bal = Number(d.opening_balance) || 0;
            if (bal > 0) recv += bal; // Positive = Receivable
            if (bal < 0) pay += Math.abs(bal); // Negative = Payable
        });

        // 5. Sort Activity (Newest First)
        activity.sort((a, b) => new Date(b._sortDate).getTime() - new Date(a._sortDate).getTime());

        setStats({ todaySale: today, monthSale: month, lowStock: low, receivable: recv, payable: pay });
        setRecentActivity(activity.slice(0, 5)); // Top 5

      } catch (e) {
        console.error("Dashboard Load Error", e);
      } finally {
        setLoading(false);
      }
    };
    loadDashboard();
  }, [user]);

  const StatCard = ({ label, value, icon: Icon, color, subValue }: any) => (
      <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
          <div>
              <p className="text-slate-500 text-xs font-bold uppercase mb-1">{label}</p>
              <h3 className="text-2xl font-bold text-slate-800">
                  {typeof value === 'number' ? `${value.toLocaleString()}` : value}
              </h3>
              {subValue && <p className="text-xs text-slate-400 mt-1">{subValue}</p>}
          </div>
          <div className={`p-3 rounded-xl ${color}`}>
              <Icon size={20} className="text-white"/>
          </div>
      </div>
  );

  return (
    <div className="p-4 md:p-6 space-y-6 pb-24">
       {/* Greeting */}
       <div className="flex justify-between items-center">
           <div>
               <h1 className="text-2xl font-bold text-slate-900">Dashboard</h1>
               <p className="text-slate-500 text-sm">Overview for today</p>
           </div>
           <div className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold">
               {new Date().toLocaleDateString()}
           </div>
       </div>

       {/* Key Stats */}
       <div className="grid grid-cols-2 gap-3">
           <StatCard 
                label="Today's Sale" 
                value={stats.todaySale} 
                icon={TrendingUp} 
                color="bg-green-500" 
                subValue={`Month: ${stats.monthSale.toLocaleString()}`}
           />
           <StatCard 
                label="Low Stock" 
                value={stats.lowStock} 
                icon={AlertTriangle} 
                color={stats.lowStock > 0 ? "bg-red-500 animate-pulse" : "bg-orange-400"}
                subValue="Items to reorder"
           />
           <StatCard 
                label="Receivable" 
                value={stats.receivable} 
                icon={ArrowRight} 
                color="bg-blue-500" 
                subValue="From Customers"
           />
           <StatCard 
                label="Payable" 
                value={stats.payable} 
                icon={ArrowRight} 
                color="bg-purple-500" 
                subValue="To Suppliers"
           />
       </div>

       {/* Quick Actions */}
       <div>
           <h3 className="text-sm font-bold text-slate-700 mb-3">Quick Actions</h3>
           <div className="grid grid-cols-4 gap-2">
               {[
                   { label: 'Sale', icon: ShoppingCart, color: 'bg-green-600', action: 'sales' },
                   { label: 'Purchase', icon: Package, color: 'bg-blue-600', action: 'purchases' },
                   { label: 'Payment', icon: TrendingDown, color: 'bg-purple-600', action: 'transactions' },
                   { label: 'Add User', icon: Users, color: 'bg-slate-700', action: 'customers' },
               ].map((btn) => (
                   <button 
                    key={btn.label}
                    onClick={() => onQuickAction(btn.action)}
                    className="flex flex-col items-center gap-2 p-3 bg-white rounded-xl border border-slate-100 shadow-sm active:scale-95 transition-all"
                   >
                       <div className={`p-3 rounded-full text-white ${btn.color}`}>
                           <btn.icon size={20}/>
                       </div>
                       <span className="text-xs font-bold text-slate-600">{btn.label}</span>
                   </button>
               ))}
           </div>
       </div>

       {/* Recent Activity */}
       <div>
           <div className="flex justify-between items-center mb-3">
               <h3 className="text-sm font-bold text-slate-700">Recent Activity</h3>
           </div>
           
           <div className="space-y-3">
               {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> : 
                recentActivity.length === 0 ? <div className="text-center py-10 text-slate-400">No activity yet.</div> :
                recentActivity.map((item) => (
                   <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                       <div className="flex items-center gap-3">
                           <div className="bg-slate-100 p-2.5 rounded-lg text-slate-500">
                               {item.type === 'sell' ? <TrendingUp size={18} className="text-green-600"/> : 
                                item.type === 'purchase' ? <Package size={18} className="text-blue-600"/> :
                                <Clock size={18}/>}
                           </div>
                           <div>
                               <h4 className="font-bold text-slate-800 text-sm">{item.party_name || 'Unknown'}</h4>
                               <p className="text-xs text-slate-400 uppercase">{item.type || 'Record'}</p>
                           </div>
                       </div>
                       <div className="text-right">
                           <div className="font-bold text-slate-900">{item.total_amount || item.amount || 0}</div>
                           <div className="text-xs text-slate-400">{item.date}</div>
                       </div>
                   </div>
               ))}
           </div>
       </div>
    </div>
  );
};

export default Dashboard;

--- FILE END: src\components\views\Dashboard.tsx ---


--- FILE START: src\components\views\DashboardView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { 
  TrendingUp, TrendingDown, ArrowUpRight, ArrowDownRight, 
  Wallet, AlertCircle, ShoppingCart, Truck, Users, 
  Package, ChevronRight, Plus
} from 'lucide-react';
import { ApiService } from '../../services/api';
import { AppSettings } from '../../types';
import { useUI } from '../../context/UIContext';

interface DashboardViewProps {
  user: User;
  appSettings: AppSettings;
  onNavigate: (view: string) => void;
  onQuickAction: (action: string) => void;
}

const DashboardView: React.FC<DashboardViewProps> = ({ user, appSettings, onNavigate, onQuickAction }) => {
  const [stats, setStats] = useState({
    sales: 0, purchases: 0, received: 0, paid: 0, receivable: 0, payable: 0
  });

  useEffect(() => {
    const loadStats = async () => {
      try {
        const [ledgerSnap, transSnap] = await Promise.all([
          ApiService.getAll(user.uid, 'ledger_entries'),
          ApiService.getAll(user.uid, 'transactions')
        ]);

        let sales = 0, purchases = 0, received = 0, paid = 0;
        
        ledgerSnap.docs.forEach(doc => {
            const d = doc.data();
            const amt = Number(d.total_amount) || 0;
            if (d.type === 'sell') sales += amt;
            if (d.type === 'purchase') purchases += amt;
        });

        transSnap.docs.forEach(doc => {
            const d = doc.data();
            const amt = Number(d.amount) || 0;
            if (d.type === 'received') received += amt;
            if (d.type === 'paid') paid += amt;
        });

        setStats({
            sales, purchases, received, paid,
            receivable: sales - received, 
            payable: purchases - paid
        });
      } catch (e) { console.error(e); }
    };
    loadStats();
  }, [user]);

  const getFontSize = (val: number) => {
      const str = val.toLocaleString('en-IN');
      const len = str.length;
      if (len > 10) return "text-lg"; 
      if (len > 8) return "text-xl";
      if (len > 6) return "text-2xl"; 
      return "text-3xl"; 
  };

  const StatCard = ({ title, value, type, icon: Icon, onClick }: any) => {
      const isPositive = type === 'success';
      const colorClass = isPositive 
          ? 'text-green-600 bg-green-50 border-green-100 dark:bg-green-900/20 dark:border-green-900/30 dark:text-green-400' 
          : 'text-red-600 bg-red-50 border-red-100 dark:bg-red-900/20 dark:border-red-900/30 dark:text-red-400';
      const iconColor = isPositive ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
      return (
          <div onClick={onClick} className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm active:scale-95 transition-all relative overflow-hidden">
              <div className="flex justify-between items-start mb-2">
                  <div className={`p-2 rounded-xl ${colorClass}`}>
                      <Icon size={20} />
                  </div>
                  {isPositive ? <ArrowUpRight className={iconColor} size={18}/> : <ArrowDownRight className={iconColor} size={18}/>}
              </div>
              <div>
                  <div className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">{title}</div>
                  <div className={`font-black text-slate-900 dark:text-white mt-0.5 tracking-tight ${getFontSize(value)}`}>
                      {appSettings.profile.currency_symbol}{value.toLocaleString('en-IN')}
                  </div>
              </div>
          </div>
      );
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 p-4 pb-24 space-y-5 overflow-y-auto transition-colors duration-200">
        <div className="flex justify-between items-center">
            <div>
                <h1 className="text-2xl font-black text-slate-900 dark:text-white">{appSettings.profile.firm_name}</h1>
                <p className="text-xs font-bold text-slate-400">Overview</p>
            </div>
            <button onClick={() => onQuickAction('ai')} className="bg-slate-900 dark:bg-blue-600 text-white p-2.5 rounded-xl shadow-lg active:scale-90 transition-all">
                <Plus size={24}/>
            </button>
        </div>

        <div className="grid grid-cols-2 gap-3">
            <StatCard title="Total Sales" value={stats.sales} type="success" icon={TrendingUp} onClick={() => onNavigate('reports')} />
            <StatCard title="Total Purchase" value={stats.purchases} type="danger" icon={TrendingDown} onClick={() => onNavigate('reports')} />
            <StatCard title="Cash Received" value={stats.received} type="success" icon={Wallet} onClick={() => onNavigate('transactions')} />
            <StatCard title="Cash Paid" value={stats.paid} type="danger" icon={Wallet} onClick={() => onNavigate('transactions')} />
        </div>

        <div className="space-y-2">
            <h3 className="text-xs font-bold text-slate-400 uppercase ml-1">Quick Actions</h3>
            <div className="grid grid-cols-4 gap-2">
                <ActionButton label="Sale" icon={ShoppingCart} color="bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400" onClick={() => onQuickAction('sale')} />
                <ActionButton label="Purchase" icon={Package} color="bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-400" onClick={() => onQuickAction('purchase')} />
                <ActionButton label="Payment" icon={Wallet} color="bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-400" onClick={() => onQuickAction('payment')} />
                {/* FIXED: Changed Vehicle to Expense */}
                <ActionButton label="Expense" icon={TrendingDown} color="bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400" onClick={() => onQuickAction('expense')} />
            </div>
        </div>

        <div className="bg-slate-900 dark:bg-slate-800 text-white p-5 rounded-3xl shadow-xl relative overflow-hidden transition-colors">
            <div className="absolute top-0 right-0 p-4 opacity-10"><AlertCircle size={100}/></div>
            <div className="relative z-10">
                <h3 className="text-sm font-bold text-slate-400 uppercase mb-4">Outstanding Balance</h3>
                <div className="flex gap-6">
                    <div>
                        <div className="text-xs text-slate-400 mb-1">You'll Get</div>
                        <div className={`font-bold text-green-400 ${getFontSize(stats.receivable)}`}>
                           {appSettings.profile.currency_symbol}{stats.receivable.toLocaleString('en-IN')}
                        </div>
                    </div>
                    <div className="w-px bg-slate-700 dark:bg-slate-600"></div>
                    <div>
                        <div className="text-xs text-slate-400 mb-1">You'll Give</div>
                        <div className={`font-bold text-red-400 ${getFontSize(stats.payable)}`}>
                           {appSettings.profile.currency_symbol}{stats.payable.toLocaleString('en-IN')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div className="h-4"></div>
    </div>
  );
};

const ActionButton = ({ label, icon: Icon, color, onClick }: any) => (
    <button onClick={onClick} className={`flex flex-col items-center justify-center gap-2 p-3 rounded-2xl ${color} active:scale-95 transition-all border border-transparent dark:border-white/5 hover:border-black/5`}>
        <Icon size={22} />
        <span className="text-[10px] font-bold uppercase">{label}</span>
    </button>
);
export default DashboardView;

--- FILE END: src\components\views\DashboardView.tsx ---


--- FILE START: src\components\views\ExpensesView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { Search, Trash2, Edit2 } from 'lucide-react'; // Added Edit2
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import { AppSettings } from '../../types';
import Header from '../common/Header';

interface ExpensesViewProps { 
    user: User; 
    onEdit: (i: any) => void; 
    appSettings: AppSettings; 
}

const ExpensesView: React.FC<ExpensesViewProps> = ({ user, onEdit, appSettings }) => {
  const { confirm, showToast } = useUI();
  const [expenses, setExpenses] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  
  useEffect(() => {
      const load = async () => {
          setLoading(true);
          try {
              const snap = await ApiService.getAll(user.uid, 'expenses');
              const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              data.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
              setExpenses(data);
          } catch(e) { console.error(e); } finally { setLoading(false); }
      };
      load();
  }, [user]);

  const handleDelete = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(await confirm("Delete?", "Undone.")) {
          await ApiService.delete(user.uid, 'expenses', id);
          setExpenses(p => p.filter(e => e.id !== id));
          showToast("Deleted", "success");
      }
  };

  const filtered = expenses.filter(e => 
      searchTerm ? e.category?.toLowerCase().includes(searchTerm) || e.notes?.toLowerCase().includes(searchTerm) : true
  );

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <Header title="Expenses" onAdd={() => onEdit(null)} count={filtered.length} />
       <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4">
           <div className="relative">
               <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
               <input className="w-full pl-9 p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-950 dark:text-white outline-none" placeholder="Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
           </div>
       </div>
       <div className="flex-1 overflow-y-auto space-y-3">
           {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> : filtered.map(item => (
               <div key={item.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex justify-between items-center">
                   <div>
                       <div className="flex items-center gap-2 mb-1">
                           <span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded">{item.date}</span>
                           <span className="text-xs font-bold text-slate-700 dark:text-slate-300 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 px-2 py-0.5 rounded-full">{item.category}</span>
                       </div>
                       <div className="text-sm font-medium text-slate-600 dark:text-slate-400">{item.notes || 'No desc'}</div>
                   </div>
                   <div className="flex flex-col items-end gap-1">
                       <span className="font-bold text-slate-900 dark:text-white text-lg">{item.amount}</span>
                       <div className="flex gap-1">
                           <button onClick={() => onEdit(item)} className="p-1.5 bg-blue-50 dark:bg-blue-900/20 text-blue-500 dark:text-blue-400 rounded-lg"><Edit2 size={14}/></button>
                           <button onClick={(e) => handleDelete(item.id, e)} className="p-1.5 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded-lg"><Trash2 size={14}/></button>
                       </div>
                   </div>
               </div>
           ))}
       </div>
    </div>
  );
};
export default ExpensesView;

--- FILE END: src\components\views\ExpensesView.tsx ---


--- FILE START: src\components\views\InventoryView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { Search, Trash2, AlertTriangle } from 'lucide-react';
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import { AppSettings } from '../../types';
import Header from '../common/Header';

interface InventoryViewProps { user: User; settings: AppSettings; onAdd: () => void; }

const InventoryView: React.FC<InventoryViewProps> = ({ user, settings, onAdd }) => {
  const { showToast, confirm } = useUI();
  const [items, setItems] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
      const load = async () => {
          setLoading(true);
          try {
              const snap = await ApiService.getAll(user.uid, 'inventory');
              setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          } catch (e) { console.error(e); } finally { setLoading(false); }
      };
      load();
  }, [user]);

  const handleDelete = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(await confirm("Delete?", "Undone.")) {
          await ApiService.delete(user.uid, 'inventory', id);
          setItems(p => p.filter(i => i.id !== id));
          showToast("Deleted", "success");
      }
  };

  const filtered = items.filter(i => searchTerm ? i.name?.toLowerCase().includes(searchTerm) : true);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <Header title="Inventory" onAdd={onAdd} count={filtered.length} />
       <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4">
           <div className="relative">
               <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
               <input className="w-full pl-9 p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-950 dark:text-white outline-none" placeholder="Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
           </div>
       </div>
       <div className="flex-1 overflow-y-auto space-y-3">
           {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> : filtered.map(item => (
               <div key={item.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex justify-between items-center">
                   <div>
                       <div className="flex items-center gap-2 mb-1">
                           <span className="text-xs font-bold text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-full">{item.name}</span>
                           {settings.automation?.low_stock_warning && (item.stock || 0) < 10 && (
                               <span className="text-[10px] font-bold text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 px-1.5 py-0.5 rounded flex items-center gap-1"><AlertTriangle size={10}/> LOW</span>
                           )}
                       </div>
                       <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Sell: {item.sale_rate}</div>
                   </div>
                   <div className="flex flex-col items-end gap-1">
                       <span className="font-black text-slate-900 dark:text-white text-lg">{item.stock || 0}</span>
                       <button onClick={(e) => handleDelete(item.id, e)} className="p-1.5 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded-lg"><Trash2 size={14}/></button>
                   </div>
               </div>
           ))}
       </div>
    </div>
  );
};
export default InventoryView;

--- FILE END: src\components\views\InventoryView.tsx ---


--- FILE START: src\components\views\LedgerView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { Search, Trash2, Truck } from 'lucide-react';
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import Header from '../common/Header';

interface LedgerViewProps { user: User; onAdd: () => void; }

const LedgerView: React.FC<LedgerViewProps> = ({ user, onAdd }) => {
  const { showToast, confirm } = useUI();
  const [entries, setEntries] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<'all' | 'sell' | 'purchase'>('all');

  useEffect(() => {
      const load = async () => {
          setLoading(true);
          try {
              const snap = await ApiService.getAll(user.uid, 'ledger_entries');
              const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              data.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
              setEntries(data);
          } catch (e) { console.error(e); } finally { setLoading(false); }
      };
      load();
  }, [user]);

  const handleDelete = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(await confirm("Delete?", "Cannot be undone.")) {
          await ApiService.delete(user.uid, 'ledger_entries', id);
          setEntries(p => p.filter(i => i.id !== id));
          showToast("Deleted", "success");
      }
  };

  const filtered = entries.filter(e => {
      if (filterType !== 'all' && e.type !== filterType) return false;
      if (searchTerm && !e.party_name?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
      return true;
  });

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <Header title="Ledger" onAdd={onAdd} count={filtered.length} />
       <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4 space-y-3">
           <div className="flex gap-2">
               <div className="flex-1 relative">
                   <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                   <input className="w-full pl-9 p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-950 dark:text-white outline-none" placeholder="Search Party..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
               </div>
               <select className="bg-slate-50 dark:bg-slate-950 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold outline-none" value={filterType} onChange={(e:any) => setFilterType(e.target.value)}>
                   <option value="all">All</option>
                   <option value="sell">Sales</option>
                   <option value="purchase">Purchase</option>
               </select>
           </div>
       </div>
       <div className="flex-1 overflow-y-auto space-y-3">
           {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> : filtered.map(item => (
               <div key={item.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col gap-2">
                   <div className="flex justify-between items-start">
                       <div>
                           <div className="flex items-center gap-2 mb-1">
                               <span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded">{item.date}</span>
                               <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${item.type === 'sell' ? 'bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-400' : 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400'}`}>{item.type === 'sell' ? 'SALE' : 'PURCHASE'}</span>
                           </div>
                           <div className="font-bold text-slate-800 dark:text-slate-200 text-sm">{item.party_name}</div>
                           <div className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{item.items?.map((i:any) => `${i.quantity} ${i.item_name}`).join(', ') || 'No Items'}</div>
                       </div>
                       <div className="flex flex-col items-end gap-1">
                           <span className="font-black text-slate-900 dark:text-white text-lg">{item.total_amount?.toLocaleString() || 0}</span>
                           <button onClick={(e) => handleDelete(item.id, e)} className="p-1.5 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded-lg active:scale-95"><Trash2 size={14}/></button>
                       </div>
                   </div>
               </div>
           ))}
       </div>
    </div>
  );
};
export default LedgerView;

--- FILE END: src\components\views\LedgerView.tsx ---


--- FILE START: src\components\views\PartiesView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { Search, Phone, MapPin, Trash2, Briefcase, User as UserIcon, X, Save } from 'lucide-react';
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import PartyDetailView from './PartyDetailView';
import Header from '../common/Header';

interface PartiesViewProps {
  user: User;
}

const PartiesView: React.FC<PartiesViewProps> = ({ user }) => {
  const { showToast, confirm } = useUI();
  const [parties, setParties] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [roleFilter, setRoleFilter] = useState<'all' | 'customer' | 'supplier'>('all');
  const [selectedParty, setSelectedParty] = useState<any | null>(null);
  
  // Modal State
  const [showModal, setShowModal] = useState(false);
  const [formData, setFormData] = useState({ name: '', contact: '', address: '', role: 'customer' });

  const fetchParties = async () => {
      setLoading(true);
      try {
          const snap = await ApiService.getAll(user.uid, 'parties');
          const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          setParties(data);
      } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  useEffect(() => { fetchParties(); }, [user]);

  const handleDelete = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(await confirm("Delete Party?", "This will remove all history.")) {
          await ApiService.delete(user.uid, 'parties', id);
          setParties(prev => prev.filter(p => p.id !== id));
          showToast("Party Deleted", "success");
      }
  };

  const handleSave = async () => {
      if (!formData.name) return showToast("Name is required", "error");
      try {
          await ApiService.add(user.uid, 'parties', { ...formData, created_at: new Date().toISOString() });
          showToast("Party Added", "success");
          setShowModal(false);
          setFormData({ name: '', contact: '', address: '', role: 'customer' });
          fetchParties();
      } catch (e) { showToast("Failed to save", "error"); }
  };

  const filtered = parties.filter(p => {
      if (roleFilter !== 'all' && p.role !== roleFilter) return false;
      if (searchTerm && !p.name?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
      return true;
  });

  if (selectedParty) {
      return <PartyDetailView party={selectedParty} user={user} onBack={() => setSelectedParty(null)} />;
  }

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <Header title="Parties" onAdd={() => setShowModal(true)} count={filtered.length} />

       <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4 space-y-3">
           <div className="flex gap-2">
               <div className="flex-1 relative">
                   <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                   <input 
                      className="w-full pl-9 p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" 
                      placeholder="Search..." 
                      value={searchTerm} 
                      onChange={e => setSearchTerm(e.target.value)} 
                   />
               </div>
               <select 
                   className="bg-slate-50 dark:bg-slate-950 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold outline-none" 
                   value={roleFilter} 
                   onChange={(e:any) => setRoleFilter(e.target.value)}
               >
                   <option value="all">All</option>
                   <option value="customer">Customers</option>
                   <option value="supplier">Suppliers</option>
               </select>
           </div>
       </div>

       <div className="flex-1 overflow-y-auto space-y-3">
           {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> :
            filtered.length === 0 ? <div className="text-center py-10 text-slate-400">No parties found.</div> :
            filtered.map(item => (
               <div key={item.id} onClick={() => setSelectedParty(item)} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex justify-between items-center active:scale-95 transition-transform">
                   <div>
                       <div className="flex items-center gap-2 mb-1">
                           <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase flex items-center gap-1 ${item.role === 'customer' ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400' : 'bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400'}`}>
                               {item.role === 'customer' ? <UserIcon size={10}/> : <Briefcase size={10}/>} {item.role}
                           </span>
                       </div>
                       <div className="font-bold text-slate-800 dark:text-white text-base">{item.name}</div>
                       <div className="text-xs text-slate-400 mt-1 flex flex-col gap-0.5">
                           {item.contact && <span className="flex items-center gap-1"><Phone size={10}/> {item.contact}</span>}
                           {item.address && <span className="flex items-center gap-1"><MapPin size={10}/> {item.address}</span>}
                       </div>
                   </div>
                   <div className="flex flex-col items-end gap-1">
                       <button onClick={(e) => handleDelete(item.id, e)} className="p-2 bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-red-500 rounded-full"><Trash2 size={16}/></button>
                   </div>
               </div>
           ))}
       </div>

       {showModal && (
           <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
               <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-4 shadow-2xl border border-slate-100 dark:border-slate-800">
                   <div className="flex justify-between items-center mb-4">
                       <h3 className="font-bold text-lg dark:text-white">Add Party</h3>
                       <button onClick={() => setShowModal(false)}><X className="dark:text-white" size={20}/></button>
                   </div>
                   <div className="space-y-3">
                       <input 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           placeholder="Name"
                           value={formData.name}
                           onChange={e => setFormData({...formData, name: e.target.value})}
                       />
                       <input 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           placeholder="Phone"
                           value={formData.contact}
                           onChange={e => setFormData({...formData, contact: e.target.value})}
                       />
                       <input 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           placeholder="Address"
                           value={formData.address}
                           onChange={e => setFormData({...formData, address: e.target.value})}
                       />
                       <select 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           value={formData.role}
                           onChange={e => setFormData({...formData, role: e.target.value})}
                       >
                           <option value="customer">Customer</option>
                           <option value="supplier">Supplier</option>
                       </select>
                       <button onClick={handleSave} className="w-full bg-slate-900 dark:bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 mt-2">
                           <Save size={18}/> Save Party
                       </button>
                   </div>
               </div>
           </div>
       )}
    </div>
  );
};
export default PartiesView;

--- FILE END: src\components\views\PartiesView.tsx ---


--- FILE START: src\components\views\PartyDetailView.tsx ---
import React, { useState, useEffect, useMemo } from 'react';
import { User } from 'firebase/auth';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '../../config/firebase';
import { 
  ArrowLeft, FileText, Phone, MapPin, 
  ShoppingBag, Banknote, List, Filter, X, Truck, 
  PieChart
} from 'lucide-react';
import { ExportService } from '../../services/export';
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import { useUI } from '../../context/UIContext';

interface PartyDetailProps {
  party: any;
  user: User;
  onBack: () => void;
}

const PartyDetailView: React.FC<PartyDetailProps> = ({ party, user, onBack }) => {
  const { showToast } = useUI();
  const [history, setHistory] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState<'details' | 'all' | 'orders' | 'payments'>('all');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');
  const [itemFilter, setItemFilter] = useState('');     
  const [sendToFilter, setSendToFilter] = useState(''); 

  const isSupplier = party.role === 'supplier';

  useEffect(() => {
    const loadHistory = async () => {
        setLoading(true);
        try {
            const q1 = query(collection(db, `users/${user.uid}/ledger_entries`), where('party_name', '==', party.name));
            const q2 = query(collection(db, `users/${user.uid}/transactions`), where('party_name', '==', party.name));
            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const list = [
                ...snap1.docs.map(d => ({ ...d.data(), id: d.id, _type: 'invoice' })),
                ...snap2.docs.map(d => ({ ...d.data(), id: d.id, _type: 'payment' }))
            ];
            list.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setHistory(list);
        } catch (e) { console.error(e); } finally { setLoading(false); }
    };
    loadHistory();
  }, [party]);

  const dateFilteredData = useMemo(() => {
      return history.filter(h => {
          if (dateFrom && h.date < dateFrom) return false;
          if (dateTo && h.date > dateTo) return false;
          return true;
      });
  }, [history, dateFrom, dateTo]);

  const detailsStats = useMemo(() => {
      let totalBusiness = 0;
      let totalPayment = 0;
      const itemMap: Record<string, { qty: number, amount: number, unit: string }> = {};

      dateFilteredData.forEach(h => {
          if (h._type === 'invoice') {
              totalBusiness += (Number(h.total_amount) || 0);
              if (h.items) {
                  h.items.forEach((i: any) => {
                      const key = i.item_name;
                      if (!itemMap[key]) itemMap[key] = { qty: 0, amount: 0, unit: i.unit };
                      itemMap[key].qty += (Number(i.quantity) || 0);
                      itemMap[key].amount += (Number(i.total) || 0);
                  });
              }
          } else {
              totalPayment += (Number(h.amount) || 0);
          }
      });

      const itemBreakdown = Object.entries(itemMap)
          .map(([name, data]) => ({ name, ...data }))
          .sort((a, b) => b.amount - a.amount);

      return { totalBusiness, totalPayment, itemBreakdown };
  }, [dateFilteredData]);

  const listViewData = useMemo(() => {
      return dateFilteredData.filter(h => {
          if (viewMode === 'orders' && h._type !== 'invoice') return false;
          if (viewMode === 'payments' && h._type !== 'payment') return false;
          
          if (!isSupplier && itemFilter) {
              if (h._type === 'payment') return false;
              const hasItem = h.items?.some((i: any) => i.item_name === itemFilter);
              if (!hasItem) return false;
          }
          if (isSupplier && sendToFilter) {
              if (h._type === 'payment') return false;
              if (h.send_to !== sendToFilter) return false;
          }
          return true;
      });
  }, [dateFilteredData, viewMode, itemFilter, sendToFilter, isSupplier]);

  const { partyItems, sendToCustomers } = useMemo(() => {
      const items = new Set<string>();
      const customers = new Set<string>();
      history.forEach(h => {
          if (h._type === 'invoice') {
              if (h.items) h.items.forEach((i: any) => items.add(i.item_name));
              if (h.send_to) customers.add(h.send_to);
          }
      });
      return { partyItems: Array.from(items).sort(), sendToCustomers: Array.from(customers).sort() };
  }, [history]);

  const handleDownload = async () => {
      if (listViewData.length === 0 && viewMode !== 'details') return showToast("No data to export", "error");
      const doc = new jsPDF();
      doc.setFontSize(18); doc.text(party.name, 14, 15);
      doc.setFontSize(10); doc.text(`Period: ${dateFrom || 'Start'} to ${dateTo || 'Present'}`, 14, 22);

      if (viewMode === 'details') {
          doc.text("SUMMARY REPORT", 14, 30);
          doc.text(`Total ${isSupplier ? 'Purchased' : 'Sold'}: ${detailsStats.totalBusiness}`, 14, 36);
          doc.text(`Total ${isSupplier ? 'Paid' : 'Received'}: ${detailsStats.totalPayment}`, 14, 42);
          const rows = detailsStats.itemBreakdown.map(i => [i.name, `${i.qty} ${i.unit}`, i.amount.toLocaleString()]);
          (doc as any).autoTable({ startY: 50, head: [['Item', 'Total Qty', 'Total Amount']], body: rows });
      } else {
          const rows = listViewData.map(h => [
              h.date, h._type === 'invoice' ? 'Order' : 'Payment',
              h._type === 'invoice' ? (h.items?.map((i:any) => i.item_name).join(', ') || 'Items') : (h.payment_mode || 'Cash'),
              h.total_amount || h.amount
          ]);
          (doc as any).autoTable({ startY: 30, head: [['Date', 'Type', 'Details', 'Amount']], body: rows });
      }
      const base64 = doc.output('datauristring').split(',')[1];
      await ExportService.saveAndOpenFile(base64, `Statement_${party.name}.pdf`, 'application/pdf');
  };

  const QuickFilterBtn = ({ mode, label, icon: Icon }: any) => (
      <button 
          onClick={() => setViewMode(mode)}
          className={`flex-1 p-3 rounded-xl border flex flex-col items-center justify-center gap-1 transition-all ${viewMode === mode ? 'bg-slate-900 dark:bg-blue-600 text-white border-slate-900 dark:border-blue-600 shadow-md' : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800 text-slate-500 dark:text-slate-400'}`}
      >
          <Icon size={18} />
          <span className="text-xs font-bold">{label}</span>
      </button>
  );

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 transition-colors">
        {/* HEADER */}
        <div className="bg-white dark:bg-slate-900 p-4 border-b dark:border-slate-800 flex items-center justify-between shadow-sm z-10">
            <div className="flex items-center gap-3">
                <button onClick={onBack} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full dark:text-white"><ArrowLeft size={20}/></button>
                <div>
                    <h2 className="font-bold text-lg leading-none dark:text-white">{party.name}</h2>
                    <span className="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold">{party.role}</span>
                </div>
            </div>
            <button onClick={handleDownload} className="p-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg active:scale-95 transition-all">
                <FileText size={20}/>
            </button>
        </div>

        {/* CONTROLS */}
        <div className="p-4 space-y-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
            <div className="flex gap-2">
                <QuickFilterBtn mode="all" label="All" icon={List} />
                <QuickFilterBtn mode="orders" label="Orders" icon={ShoppingBag} />
                <QuickFilterBtn mode="payments" label="Payments" icon={Banknote} />
                <QuickFilterBtn mode="details" label="Details" icon={PieChart} />
            </div>

            <div className="bg-slate-50 dark:bg-slate-950 p-3 rounded-xl border border-slate-100 dark:border-slate-800 space-y-3">
                <div className="flex gap-2 items-center text-xs font-bold text-slate-400 uppercase mb-1">
                    <Filter size={12}/> Date Range
                </div>
                <div className="flex gap-2">
                    <input type="date" className="flex-1 bg-white dark:bg-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-bold" value={dateFrom} onChange={e => setDateFrom(e.target.value)} />
                    <span className="self-center text-slate-300">-</span>
                    <input type="date" className="flex-1 bg-white dark:bg-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-bold" value={dateTo} onChange={e => setDateTo(e.target.value)} />
                </div>
                
                {viewMode !== 'details' && (
                    <>
                        {!isSupplier && partyItems.length > 0 && (
                            <div className="relative">
                                <select className="w-full bg-white dark:bg-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-bold appearance-none" value={itemFilter} onChange={e => setItemFilter(e.target.value)}>
                                    <option value="">Item Filter (All)</option>
                                    {partyItems.map(item => <option key={item} value={item}>{item}</option>)}
                                </select>
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"></div>
                                {itemFilter && <button onClick={() => setItemFilter('')} className="absolute right-8 top-1/2 -translate-y-1/2 text-slate-400"><X size={12}/></button>}
                            </div>
                        )}
                        {isSupplier && sendToCustomers.length > 0 && (
                            <div className="relative">
                                <select className="w-full bg-white dark:bg-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-bold appearance-none" value={sendToFilter} onChange={e => setSendToFilter(e.target.value)}>
                                    <option value="">Send To Filter (All)</option>
                                    {sendToCustomers.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"></div>
                                {sendToFilter && <button onClick={() => setSendToFilter('')} className="absolute right-8 top-1/2 -translate-y-1/2 text-slate-400"><X size={12}/></button>}
                            </div>
                        )}
                    </>
                )}
            </div>
        </div>

        {/* CONTENT AREA */}
        <div className="flex-1 overflow-y-auto bg-slate-50 dark:bg-slate-950">
            {viewMode === 'details' ? (
                <div className="p-4 space-y-4">
                     <div className="grid grid-cols-2 gap-3">
                         <div className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm">
                             <div className="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1"><ShoppingBag size={10}/> Total {isSupplier ? 'Purchased' : 'Sold'}</div>
                             <div className="text-xl font-bold text-slate-900 dark:text-white">{detailsStats.totalBusiness.toLocaleString()}</div>
                         </div>
                         <div className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm">
                             <div className="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1"><Banknote size={10}/> Total {isSupplier ? 'Paid' : 'Received'}</div>
                             <div className="text-xl font-bold text-green-600 dark:text-green-400">{detailsStats.totalPayment.toLocaleString()}</div>
                         </div>
                     </div>
                     
                     <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm overflow-hidden">
                         <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 font-bold text-xs text-slate-600 dark:text-slate-400 uppercase flex items-center gap-2">
                             <List size={14}/> Item Breakdown
                         </div>
                         {detailsStats.itemBreakdown.length === 0 ? (
                             <div className="p-8 text-center text-slate-400 text-xs">No items found in this period.</div>
                         ) : (
                             <div className="divide-y divide-slate-50 dark:divide-slate-800">
                                 {detailsStats.itemBreakdown.map((item, idx) => (
                                     <div key={idx} className="p-3 flex justify-between items-center">
                                         <div>
                                             <div className="font-bold text-slate-800 dark:text-slate-200 text-sm">{item.name}</div>
                                             <div className="text-xs text-slate-500 dark:text-slate-400 font-bold bg-slate-100 dark:bg-slate-800 inline-block px-1.5 rounded mt-0.5">
                                                 {item.qty} {item.unit}
                                             </div>
                                         </div>
                                         <div className="text-right font-bold text-slate-700 dark:text-slate-300">
                                             {item.amount.toLocaleString()}
                                         </div>
                                     </div>
                                 ))}
                             </div>
                         )}
                     </div>
                </div>
            ) : (
                <div className="p-4 space-y-3">
                    {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> : 
                     listViewData.length === 0 ? <div className="text-center py-10 text-slate-400">No records found.</div> :
                     listViewData.map((item, i) => (
                         <div key={i} className="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col gap-2">
                             <div className="flex justify-between items-start">
                                 <div>
                                     <div className="flex items-center gap-2 mb-1">
                                         <span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded">{item.date}</span>
                                         <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${item._type === 'invoice' ? 'bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400' : 'bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-400'}`}>
                                             {item._type === 'invoice' ? 'ORDER' : 'PAYMENT'}
                                         </span>
                                     </div>
                                     <div className="font-medium text-slate-800 dark:text-slate-200 text-sm">
                                        {item._type === 'invoice' ? (
                                            <span>{item.items?.map((it:any) => `${it.quantity} ${it.item_name}`).join(', ')}</span>
                                        ) : (
                                            `${item.payment_mode || 'Cash'} - ${item.payment_purpose || 'Payment'}`
                                        )}
                                     </div>
                                 </div>
                                 <div className="font-bold text-lg text-slate-900 dark:text-white">{item.total_amount || item.amount}</div>
                             </div>
                             {item._type === 'invoice' && item.send_to && (
                                 <div className="border-t border-slate-50 dark:border-slate-800 pt-2 text-[10px] text-green-600 dark:text-green-400 font-bold flex gap-2 items-center">
                                     <Truck size={12}/> Sent To: {item.send_to}
                                 </div>
                             )}
                         </div>
                     ))
                    }
                </div>
            )}
        </div>
    </div>
  );
};
export default PartyDetailView;

--- FILE END: src\components\views\PartyDetailView.tsx ---


--- FILE START: src\components\views\ReportsView.tsx ---
import React from 'react';
import { User } from 'firebase/auth';
import { ArrowLeft, TrendingUp } from 'lucide-react';

interface ReportsViewProps { 
    user: User; 
    onBack: () => void; // Added onBack prop
}

const ReportsView: React.FC<ReportsViewProps> = ({ user, onBack }) => {
  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <div className="flex items-center gap-3 mb-4">
           <button onClick={onBack} className="p-2 -ml-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors text-slate-700 dark:text-white">
               <ArrowLeft size={24}/>
           </button>
           <h1 className="text-2xl font-black text-slate-900 dark:text-white">Reports</h1>
       </div>
       <div className="flex-1 flex flex-col items-center justify-center text-center opacity-50">
           <TrendingUp size={64} className="text-slate-300 dark:text-slate-700 mb-6"/>
           <h3 className="text-xl font-bold text-slate-600 dark:text-slate-400 mb-2">Advanced Analytics</h3>
           <p className="text-sm text-slate-400 dark:text-slate-600 max-w-[240px] leading-relaxed">
               Detailed profit/loss graphs and exportable tax reports will be available in the next update.
           </p>
       </div>
    </div>
  );
};
export default ReportsView;

--- FILE END: src\components\views\ReportsView.tsx ---


--- FILE START: src\components\views\SettingsView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { 
  ArrowLeft, Moon, Volume2, LogOut, RefreshCw, 
  Database, AlertTriangle, ChevronRight 
} from 'lucide-react';
import { ApiService } from '../../services/api';
import { DataService } from '../../services/data';
import { AppSettings, UserProfile } from '../../types';
import { useUI } from '../../context/UIContext';
import { setHapticsEnabled } from '../../utils/haptics';
import RecycleBin from '../common/RecycleBin';

interface SettingsViewProps {
  user: User;
  appSettings: AppSettings;
  onUpdateSettings: (s: AppSettings) => void;
  onBack: () => void; // <--- ADDED: Fixes "Stuck in Settings"
}

const SettingsView: React.FC<SettingsViewProps> = ({ user, appSettings, onUpdateSettings, onBack }) => {
  const { showToast, confirm } = useUI();
  const [activeTab, setActiveTab] = useState<'profile' | 'lists' | 'data'>('profile');
  const [loading, setLoading] = useState(false);
  const [showRecycleBin, setShowRecycleBin] = useState(false);

  const [profile, setProfile] = useState<UserProfile>(appSettings.profile);
  // ... (State logic same as before) ...
  // Re-implementing simplified state logic for brevity but ensuring functionality
  const [customLists, setCustomLists] = useState(appSettings.custom_lists || { expense_types: [], payment_modes: [], received_by_names: [], paid_by_names: [], purposes: [] });
  const [newItem, setNewItem] = useState('');

  useEffect(() => {
      setProfile(appSettings.profile);
      setCustomLists(appSettings.custom_lists || { expense_types: [], payment_modes: [], received_by_names: [], paid_by_names: [], purposes: [] });
  }, [appSettings]);

  const handleSaveProfile = async () => {
      setLoading(true);
      try {
          const newSettings = { ...appSettings, profile };
          await ApiService.updateSettings(user.uid, newSettings);
          onUpdateSettings(newSettings);
          showToast("Profile Saved", "success");
      } catch (e) { showToast("Save Failed", "error"); }
      setLoading(false);
  };

  const handleToggle = async (field: 'haptics_enabled' | 'dark_mode') => {
      const currentPrefs = appSettings.preferences || { haptics_enabled: true, dark_mode: false, language: 'en' };
      const newSettings = { ...appSettings, preferences: { ...currentPrefs, [field]: !currentPrefs[field] } };
      if (field === 'haptics_enabled') setHapticsEnabled(newSettings.preferences.haptics_enabled);
      await ApiService.updateSettings(user.uid, newSettings);
      onUpdateSettings(newSettings);
  };

  const handleAddListItem = async (listName: string) => {
      if (!newItem.trim()) return;
      const currentList = customLists[listName as keyof typeof customLists] || [];
      const newLists = { ...customLists, [listName]: [...currentList, newItem] };
      setCustomLists(newLists);
      setNewItem('');
      const newSettings = { ...appSettings, custom_lists: newLists };
      await ApiService.updateSettings(user.uid, newSettings);
      onUpdateSettings(newSettings);
  };

  const handleDeleteListItem = async (listName: string, item: string) => {
      if (await confirm("Delete Item?", `Remove '${item}'?`)) {
          const currentList = customLists[listName as keyof typeof customLists] || [];
          const newLists = { ...customLists, [listName]: currentList.filter(i => i !== item) };
          setCustomLists(newLists);
          const newSettings = { ...appSettings, custom_lists: newLists };
          await ApiService.updateSettings(user.uid, newSettings);
          onUpdateSettings(newSettings);
      }
  };

  const handleBackup = async () => {
      setLoading(true);
      const res = await DataService.backupData(user.uid);
      showToast(res.message, res.success ? 'success' : 'error');
      setLoading(false);
  };

  if (showRecycleBin) return <RecycleBin user={user} onBack={() => setShowRecycleBin(false)} />;

  const ListEditor = ({ title, field }: { title: string, field: string }) => (
      <div className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4">
          <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-3">{title}</h3>
          <div className="flex flex-wrap gap-2 mb-3">
              {(customLists[field as keyof typeof customLists] || []).map((item, i) => (
                  <div key={i} className="bg-slate-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 dark:text-slate-300">
                      {item}
                      <button onClick={() => handleDeleteListItem(field, item)} className="text-slate-400 hover:text-red-500"></button>
                  </div>
              ))}
          </div>
          <div className="flex gap-2">
              <input className="flex-1 border dark:border-slate-700 dark:bg-slate-950 dark:text-white rounded-lg px-3 py-2 text-sm font-bold" placeholder="Add new..." value={newItem} onChange={e => setNewItem(e.target.value)} onKeyDown={e => { if(e.key === 'Enter') handleAddListItem(field); }} />
              <button onClick={() => handleAddListItem(field)} className="bg-slate-900 dark:bg-blue-600 text-white p-2 rounded-lg font-bold text-xs">ADD</button>
          </div>
      </div>
  );

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pt-12 pb-6 px-4"> {/* ADDED pt-12 for Status Bar */}
        {/* HEADER WITH BACK BUTTON */}
        <div className="flex items-center gap-3 mb-6">
            <button onClick={onBack} className="p-3 bg-white dark:bg-slate-800 rounded-full shadow-sm active:scale-95 transition-all">
                <ArrowLeft size={20} className="text-slate-900 dark:text-white"/>
            </button>
            <h1 className="text-3xl font-black text-slate-900 dark:text-white">Settings</h1>
        </div>

        <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
            {['profile', 'lists', 'data'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab as any)} className={`px-5 py-2.5 rounded-full text-xs font-black uppercase tracking-wider transition-all ${activeTab === tab ? 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-lg' : 'bg-white dark:bg-slate-900 text-slate-500'}`}>
                    {tab}
                </button>
            ))}
        </div>

        <div className="flex-1 overflow-y-auto">
            {activeTab === 'profile' && (
                <div className="space-y-4">
                    <div className="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 space-y-4">
                        <Input label="Business Name" value={profile.firm_name} onChange={(v: string) => setProfile({...profile, firm_name: v})} />
                        <Input label="Owner Name" value={profile.owner_name} onChange={(v: string) => setProfile({...profile, owner_name: v})} />
                        <Input label="Phone" value={profile.contact} onChange={(v: string) => setProfile({...profile, contact: v})} />
                        <Input label="Address" value={profile.address} onChange={(v: string) => setProfile({...profile, address: v})} />
                        <Input label="Currency" value={profile.currency_symbol} onChange={(v: string) => setProfile({...profile, currency_symbol: v})} w="w-24" />
                        <button onClick={handleSaveProfile} disabled={loading} className="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition-all">
                            {loading ? 'Saving...' : 'Save Profile'}
                        </button>
                    </div>
                    
                    <div className="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3"><Volume2 size={20} className="text-slate-400"/> <span className="font-bold text-slate-700 dark:text-white">Haptic Feedback</span></div>
                            <Toggle checked={appSettings.preferences?.haptics_enabled || false} onChange={() => handleToggle('haptics_enabled')} />
                        </div>
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3"><Moon size={20} className="text-slate-400"/> <span className="font-bold text-slate-700 dark:text-white">Dark Mode</span></div>
                            <Toggle checked={appSettings.preferences?.dark_mode || false} onChange={() => handleToggle('dark_mode')} />
                        </div>
                    </div>
                    
                    <button onClick={() => window.location.reload()} className="w-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
                        <LogOut size={20}/> Logout App
                    </button>
                </div>
            )}
            {activeTab === 'lists' && (
                <div>
                    <ListEditor title="Expense Categories" field="expense_types" />
                    <ListEditor title="Payment Modes" field="payment_modes" />
                </div>
            )}
            {activeTab === 'data' && (
                <div className="space-y-4">
                    <button onClick={() => setShowRecycleBin(true)} className="w-full bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 flex items-center justify-between group active:scale-95 transition-all">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg"><RefreshCw size={24}/></div>
                            <div className="text-left"><h3 className="font-bold text-slate-800 dark:text-white">Recycle Bin</h3></div>
                        </div>
                        <ChevronRight className="text-slate-300"/>
                    </button>
                    <button onClick={handleBackup} className="w-full bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 flex items-center justify-between group active:scale-95 transition-all">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg"><Database size={24}/></div>
                            <div className="text-left"><h3 className="font-bold text-slate-800 dark:text-white">Backup Data</h3></div>
                        </div>
                        <ChevronRight className="text-slate-300"/>
                    </button>
                </div>
            )}
        </div>
    </div>
  );
};

const Input = ({ label, value, onChange, w }: any) => (
    <div>
        <label className="block text-xs font-bold text-slate-400 uppercase mb-1">{label}</label>
        <input className={`w-full bg-slate-50 dark:bg-slate-950 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 ${w || ''}`} value={value || ''} onChange={e => onChange(e.target.value)} />
    </div>
);

const Toggle = ({ checked, onChange }: any) => (
    <div onClick={onChange} className={`w-12 h-7 rounded-full p-1 cursor-pointer transition-all ${checked ? 'bg-green-500' : 'bg-slate-200 dark:bg-slate-700'}`}><div className={`w-5 h-5 bg-white rounded-full shadow-md transition-all ${checked ? 'translate-x-5' : 'translate-x-0'}`} /></div>
);

export default SettingsView;

--- FILE END: src\components\views\SettingsView.tsx ---


--- FILE START: src\components\views\TransactionsView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { Search, Trash2 } from 'lucide-react';
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import Header from '../common/Header';

interface TransactionsViewProps { user: User; onAdd: () => void; }

const TransactionsView: React.FC<TransactionsViewProps> = ({ user, onAdd }) => {
  const { showToast, confirm } = useUI();
  const [transactions, setTransactions] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<'all' | 'received' | 'paid'>('all');

  useEffect(() => {
      const load = async () => {
          setLoading(true);
          try {
              const snap = await ApiService.getAll(user.uid, 'transactions');
              const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              data.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
              setTransactions(data);
          } catch (e) { console.error(e); } finally { setLoading(false); }
      };
      load();
  }, [user]);

  const handleDelete = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(await confirm("Delete?", "Cannot be undone.")) {
          await ApiService.delete(user.uid, 'transactions', id);
          setTransactions(p => p.filter(i => i.id !== id));
          showToast("Deleted", "success");
      }
  };

  const filtered = transactions.filter(t => {
      if (filterType !== 'all' && t.type !== filterType) return false;
      if (searchTerm && !t.party_name?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
      return true;
  });

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <Header title="Transactions" onAdd={onAdd} count={filtered.length} />
       <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4 space-y-3">
           <div className="flex gap-2">
               <div className="flex-1 relative">
                   <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                   <input className="w-full pl-9 p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-950 dark:text-white outline-none" placeholder="Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
               </div>
               <select className="bg-slate-50 dark:bg-slate-950 dark:text-white border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold outline-none" value={filterType} onChange={(e:any) => setFilterType(e.target.value)}>
                   <option value="all">All</option>
                   <option value="received">Received</option>
                   <option value="paid">Paid</option>
               </select>
           </div>
       </div>
       <div className="flex-1 overflow-y-auto space-y-3">
           {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> : filtered.map(item => (
               <div key={item.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex justify-between items-center">
                   <div>
                       <div className="flex items-center gap-2 mb-1">
                           <span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded">{item.date}</span>
                           <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${item.type === 'received' ? 'bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-400' : 'bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400'}`}>{item.type === 'received' ? 'RECEIVED' : 'PAID'}</span>
                       </div>
                       <div className="font-bold text-slate-800 dark:text-slate-200 text-sm">{item.party_name}</div>
                   </div>
                   <div className="flex flex-col items-end gap-1">
                       <span className={`font-black text-lg ${item.type === 'received' ? 'text-green-600 dark:text-green-400' : 'text-slate-900 dark:text-white'}`}>{item.type === 'received' ? '+' : '-'} {item.amount?.toLocaleString()}</span>
                       <button onClick={(e) => handleDelete(item.id, e)} className="p-1.5 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded-lg active:scale-95"><Trash2 size={14}/></button>
                   </div>
               </div>
           ))}
       </div>
    </div>
  );
};
export default TransactionsView;

--- FILE END: src\components\views\TransactionsView.tsx ---


--- FILE START: src\components\views\VehicleDetailView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '../../config/firebase';
import { 
  ArrowLeft, Truck, Calendar, MapPin, 
  IndianRupee, FileText, Filter, CheckCircle2 
} from 'lucide-react';
import { ExportService } from '../../services/export';
import { useUI } from '../../context/UIContext';

interface VehicleDetailProps {
  vehicle: any;
  user: User;
  onBack: () => void;
  appSettings: any;
}

const VehicleDetailView: React.FC<VehicleDetailProps> = ({ vehicle, user, onBack, appSettings }) => {
  const { showToast } = useUI();
  const [loading, setLoading] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  
  // --- FILTERS ---
  const [dateFrom, setDateFrom] = useState(new Date().toISOString().split('T')[0]); // Default Today
  const [dateTo, setDateTo] = useState(new Date().toISOString().split('T')[0]);     // Default Today
  // Vehicle No filter is implicit since we are viewing a specific vehicle, 
  // but we display it as a locked filter for clarity.

  useEffect(() => {
    const loadTrips = async () => {
        setLoading(true);
        try {
            // Fetch ALL sales where this vehicle was used
            const q = query(
                collection(db, `users/${user.uid}/ledger_entries`), 
                where('vehicle', '==', vehicle.vehicle_number),
                where('type', '==', 'sell')
            );
            const snap = await getDocs(q);
            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Sort by Date Descending
            data.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setTrips(data);
        } catch (e) { 
            console.error(e); 
            showToast("Failed to load vehicle history", "error");
        } finally { 
            setLoading(false); 
        }
    };
    loadTrips();
  }, [vehicle]);

  // --- CLIENT SIDE FILTERING ---
  const filteredTrips = trips.filter(t => {
      if (t.date < dateFrom || t.date > dateTo) return false;
      return true;
  });

  // --- TOTALS CALCULATION ---
  const totalRent = filteredTrips.reduce((sum, t) => sum + (Number(t.vehicle_rent) || 0), 0);
  const totalTrips = filteredTrips.length;

  // --- PDF EXPORT ---
  const handleDownload = async () => {
      if (filteredTrips.length === 0) return showToast("No records to export", "error");
      
      const headers = ['Date', 'Customer', 'Items', 'Rent'];
      const data = filteredTrips.map(t => ({
          Date: t.date,
          Customer: t.party_name,
          Items: t.items?.map((i:any) => i.item_name).join(', ') || '-',
          Rent: t.vehicle_rent || 0
      }));
      
      await ExportService.exportToCSV(data, Object.keys(data[0]), `Vehicle_${vehicle.vehicle_number}_Report.csv`);
      showToast("Report Saved", "success");
  };

  return (
    <div className="flex flex-col h-full bg-slate-50">
        {/* HEADER */}
        <div className="bg-white p-4 border-b flex items-center justify-between shadow-sm z-10">
            <div className="flex items-center gap-3">
                <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full text-slate-600"><ArrowLeft size={20}/></button>
                <div>
                    <h2 className="font-bold text-lg leading-none flex items-center gap-2">
                        <Truck size={18} className="text-blue-600"/>
                        {vehicle.vehicle_number}
                    </h2>
                    <span className="text-xs text-slate-500">{vehicle.owner_name}  {vehicle.driver_name || 'No Driver'}</span>
                </div>
            </div>
            <button onClick={handleDownload} className="p-2 bg-blue-50 text-blue-600 rounded-lg"><FileText size={20}/></button>
        </div>
        
        {/* FILTERS & STATS AREA */}
        <div className="p-4 bg-white border-b space-y-4">
            {/* Filter Inputs */}
            <div className="flex gap-3 items-end">
                <div className="flex-1">
                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Date From</label>
                    <input type="date" className="w-full bg-slate-50 border rounded-lg p-2 text-sm font-bold" value={dateFrom} onChange={e => setDateFrom(e.target.value)} />
                </div>
                <div className="flex-1">
                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Date To</label>
                    <input type="date" className="w-full bg-slate-50 border rounded-lg p-2 text-sm font-bold" value={dateTo} onChange={e => setDateTo(e.target.value)} />
                </div>
            </div>

            {/* Active Filter Badge (Vehicle No) */}
            <div className="flex items-center gap-2">
                <div className="bg-slate-100 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-2 border border-slate-200">
                    <Filter size={12}/> Vehicle: {vehicle.vehicle_number}
                </div>
                <div className="text-xs text-slate-400 font-medium ml-auto">
                    {totalTrips} Records Found
                </div>
            </div>
        </div>

        {/* SUMMARY CARDS */}
        <div className="p-4 grid grid-cols-2 gap-3">
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                <div className="text-slate-500 text-xs font-bold uppercase mb-1">Total Trips</div>
                <div className="text-2xl font-bold text-slate-900">{totalTrips}</div>
            </div>
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                <div className="text-slate-500 text-xs font-bold uppercase mb-1">Total Rent</div>
                <div className="text-2xl font-bold text-green-600">{totalRent.toLocaleString()}</div>
            </div>
        </div>

        {/* SALE ORDER LIST */}
        <div className="flex-1 overflow-y-auto px-4 pb-4 space-y-3">
            <h3 className="text-xs font-bold text-slate-500 uppercase ml-1">Trip History</h3>
            
            {loading ? <div className="text-center py-10 text-slate-400">Loading history...</div> : 
             filteredTrips.length === 0 ? <div className="text-center py-10 text-slate-400">No trips found in this period.</div> :
             filteredTrips.map(trip => (
                <div key={trip.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{trip.date}</span>
                            <div className="font-bold text-slate-800 text-sm mt-1">{trip.party_name}</div>
                        </div>
                        <div className="text-right">
                             <div className="font-bold text-green-600">{trip.vehicle_rent || 0}</div>
                             <div className="text-[10px] text-slate-400">Rent</div>
                        </div>
                    </div>
                    {/* Items Summary */}
                    <div className="text-xs text-slate-500 border-t pt-2 mt-2">
                        {trip.items?.map((i: any, k: number) => (
                            <span key={k} className="mr-2">
                                {i.quantity} {i.unit} {i.item_name}
                            </span>
                        ))}
                    </div>
                    {/* Trip Status Indicator (Visual only) */}
                    <div className="mt-2 flex items-center gap-1 text-[10px] text-green-600 font-bold">
                        <CheckCircle2 size={10}/> Trip Completed
                    </div>
                </div>
            ))}
        </div>
    </div>
  );
};

export default VehicleDetailView;

--- FILE END: src\components\views\VehicleDetailView.tsx ---


--- FILE START: src\components\views\VehiclesView.tsx ---
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { Search, Truck, Trash2, User as UserIcon, X, Save } from 'lucide-react';
import { ApiService } from '../../services/api';
import { useUI } from '../../context/UIContext';
import Header from '../common/Header';

interface VehiclesViewProps {
  user: User;
}

const VehiclesView: React.FC<VehiclesViewProps> = ({ user }) => {
  const { showToast, confirm } = useUI();
  const [vehicles, setVehicles] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  
  // Modal State
  const [showModal, setShowModal] = useState(false);
  const [formData, setFormData] = useState({ vehicle_number: '', owner_name: '', driver_name: '' });

  const fetchVehicles = async () => {
      setLoading(true);
      try {
          const snap = await ApiService.getAll(user.uid, 'vehicles');
          const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          setVehicles(data);
      } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  useEffect(() => { fetchVehicles(); }, [user]);

  const handleDelete = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(await confirm("Delete Vehicle?", "This cannot be undone.")) {
          await ApiService.delete(user.uid, 'vehicles', id);
          setVehicles(prev => prev.filter(v => v.id !== id));
          showToast("Vehicle Deleted", "success");
      }
  };

  const handleSave = async () => {
      if (!formData.vehicle_number) return showToast("Vehicle Number is required", "error");
      try {
          await ApiService.add(user.uid, 'vehicles', { ...formData, created_at: new Date().toISOString() });
          showToast("Vehicle Added", "success");
          setShowModal(false);
          setFormData({ vehicle_number: '', owner_name: '', driver_name: '' });
          fetchVehicles();
      } catch (e) { showToast("Failed to save", "error"); }
  };

  const filtered = vehicles.filter(v => 
      searchTerm ? v.vehicle_number?.toLowerCase().includes(searchTerm.toLowerCase()) : true
  );

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-950 pb-24 px-4 pt-4 md:px-6 transition-colors">
       <Header title="Vehicles" onAdd={() => setShowModal(true)} count={filtered.length} />

       <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-4">
           <div className="relative">
               <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
               <input 
                  className="w-full pl-9 p-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm bg-slate-50 dark:bg-slate-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" 
                  placeholder="Search Number..." 
                  value={searchTerm} 
                  onChange={e => setSearchTerm(e.target.value)} 
               />
           </div>
       </div>

       <div className="flex-1 overflow-y-auto space-y-3">
           {loading ? <div className="text-center py-10 text-slate-400">Loading...</div> :
            filtered.length === 0 ? <div className="text-center py-10 text-slate-400">No vehicles found.</div> :
            filtered.map(item => (
               <div key={item.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex justify-between items-center">
                   <div>
                       <div className="flex items-center gap-2 mb-1">
                           <span className="text-xs font-bold text-slate-700 dark:text-white bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded flex items-center gap-1">
                               <Truck size={12}/> {item.vehicle_number}
                           </span>
                       </div>
                       <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex flex-col gap-0.5">
                           {item.owner_name && <span className="flex items-center gap-1"><UserIcon size={10}/> Owner: {item.owner_name}</span>}
                           {item.driver_name && <span className="flex items-center gap-1"><UserIcon size={10}/> Driver: {item.driver_name}</span>}
                       </div>
                   </div>
                   <button onClick={(e) => handleDelete(item.id, e)} className="p-2 bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-red-500 rounded-full"><Trash2 size={16}/></button>
               </div>
           ))}
       </div>

       {showModal && (
           <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
               <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-4 shadow-2xl border border-slate-100 dark:border-slate-800">
                   <div className="flex justify-between items-center mb-4">
                       <h3 className="font-bold text-lg dark:text-white">Add Vehicle</h3>
                       <button onClick={() => setShowModal(false)}><X className="dark:text-white" size={20}/></button>
                   </div>
                   <div className="space-y-3">
                       <input 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           placeholder="Vehicle Number (e.g. UP70...)"
                           value={formData.vehicle_number}
                           onChange={e => setFormData({...formData, vehicle_number: e.target.value})}
                       />
                       <input 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           placeholder="Owner Name"
                           value={formData.owner_name}
                           onChange={e => setFormData({...formData, owner_name: e.target.value})}
                       />
                       <input 
                           className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold"
                           placeholder="Driver Name"
                           value={formData.driver_name}
                           onChange={e => setFormData({...formData, driver_name: e.target.value})}
                       />
                       <button onClick={handleSave} className="w-full bg-slate-900 dark:bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 mt-2">
                           <Save size={18}/> Save Vehicle
                       </button>
                   </div>
               </div>
           </div>
       )}
    </div>
  );
};
export default VehiclesView;

--- FILE END: src\components\views\VehiclesView.tsx ---


--- FILE START: src\config\constants.ts ---
import { AppSettings } from '../types';

// FIX: Cast (import.meta as any) to bypass strict TS check on .env
export const GEMINI_API_KEY = (import.meta as any).env.VITE_GEMINI_API_KEY || "";

export const DEFAULT_SETTINGS: AppSettings = {
  profile: {
      firm_name: "My Enterprise",
      owner_name: "Owner",
      address: "",
      gstin: "",
      contact: "",
      currency_symbol: "",
  },
  preferences: {
      dark_mode: false,
      haptics_enabled: true,
      language: 'en'
  },
  automation: {
      enable_date_filter: true,
      auto_calculate_gst: true,
      auto_update_inventory: true,
      show_delete_btn: true,
      enable_vibration: true,
      default_unit: 'Pcs',
      low_stock_warning: true,
      allow_negative_stock: true
  },
  field_visibility: {
      ledger: {
          invoice_no: true,
          vehicle: true,
          vehicle_rent: true,
          payment_received_by: true,
          notes: true,
          address: true,
          paid_to: true
      },
      transactions: {
          received_by: true,
          paid_by: true,
          notes: true
      },
      inventory: {
          hsn_code: true,
          gst_percent: true,
          price_type: true,
          supplier_name: true
      },
      parties: {
          gstin: true,
          address: true,
          site: true,
          state: true
      },
      vehicles: {
          driver_name: true,
          model: true,
          notes: true
      }
  },
  custom_lists: {
      expense_types: ['Rent', 'Electricity', 'Salary', 'Tea/Snacks', 'Fuel', 'Maintenance', 'Other'],
      payment_modes: ['Cash', 'UPI', 'Bank Transfer', 'Cheque'],
      received_by_names: ['Owner', 'Manager', 'Staff'],
      paid_by_names: ['Owner', 'Manager'],
      purposes: ['Advance', 'Bill Payment', 'Loan', 'Other']
  }
};

--- FILE END: src\config\constants.ts ---


--- FILE START: src\config\firebase.ts ---
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager } from 'firebase/firestore';

const firebaseConfig = {
  apiKey: "AIzaSyBl8QwvuFjGSCy-SxlRxbZZ8eqdbbAMBx8",
  authDomain: "inventory-20248.firebaseapp.com",
  projectId: "inventory-20248",
  storageBucket: "inventory-20248.firebasestorage.app",
  messagingSenderId: "732972722987",
  appId: "1:732972722987:web:eccd5cac27654e2460f36e",
  measurementId: "G-CRCLLG0811"
};

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = initializeFirestore(app, {
  localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
});

--- FILE END: src\config\firebase.ts ---


--- FILE START: src\context\AuthContext.tsx ---
import React, { createContext, useContext, useEffect, useState } from 'react';
import { 
  GoogleAuthProvider, 
  signInWithPopup, // <--- THE KEY FIX (Was signInWithRedirect)
  signOut, 
  onAuthStateChanged, 
  User 
} from 'firebase/auth';
import { auth, db } from '../config/firebase';
import { doc, getDoc, setDoc } from 'firebase/firestore';

interface AuthContextType {
  user: User | null;
  loading: boolean;
  loginWithGoogle: () => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType>({} as AuthContextType);

export const useAuth = () => useContext(AuthContext);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  // --- LOGIN FUNCTION FIX ---
  const loginWithGoogle = async () => {
    try {
      const provider = new GoogleAuthProvider();
      // Force account selection to prevent auto-login loops
      provider.setCustomParameters({ prompt: 'select_account' });

      // FIX: Used signInWithPopup instead of signInWithRedirect
      // This bypasses the 'sessionStorage' partitioning error on mobile
      const result = await signInWithPopup(auth, provider);
      
      const user = result.user;

      // Check if user exists in DB, if not create basic profile
      const userRef = doc(db, 'users', user.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        await setDoc(userRef, {
          email: user.email,
          displayName: user.displayName,
          photoURL: user.photoURL,
          createdAt: new Date().toISOString(),
          role: 'shopkeeper' // Default role
        });
      }

    } catch (error: any) {
      console.error("Google Login Error:", error);
      // If popup is blocked by browser, alert user
      if (error.code === 'auth/popup-blocked') {
        alert("Please allow popups for this site to sign in.");
      } else if (error.code === 'auth/popup-closed-by-user') {
        // User closed window, ignore
      } else {
        alert("Login Failed: " + error.message);
      }
    }
  };

  const logout = () => signOut(auth);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  return (
    <AuthContext.Provider value={{ user, loading, loginWithGoogle, logout }}>
      {!loading && children}
    </AuthContext.Provider>
  );
};

--- FILE END: src\context\AuthContext.tsx ---


--- FILE START: src\context\UIContext.tsx ---
import React, { createContext, useContext, useState, useCallback } from 'react';
import Toast, { ToastType } from '../components/common/Toast';
import ConfirmDialog from '../components/common/ConfirmDialog';

// UPDATED INTERFACE: Added onAction and actionLabel
interface ToastData { 
    id: string; 
    message: string; 
    type: ToastType; 
    actionLabel?: string;
    onAction?: () => void;
}

interface UIContextType {
  // Update function signature
  showToast: (message: string, type?: ToastType, actionLabel?: string, onAction?: () => void) => void;
  confirm: (title: string, message: string) => Promise<boolean>;
}

const UIContext = createContext<UIContextType | null>(null);

export const UIProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [toasts, setToasts] = useState<ToastData[]>([]);
  // ... confirm state logic (keep existing) ...
  const [confirmState, setConfirmState] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    resolve: ((value: boolean) => void) | null;
  }>({ isOpen: false, title: '', message: '', resolve: null });

  // UPDATED: showToast now accepts action parameters
  const showToast = useCallback((message: string, type: ToastType = 'success', actionLabel?: string, onAction?: () => void) => {
    const id = Date.now().toString();
    setToasts(prev => [...prev, { id, message, type, actionLabel, onAction }]);
  }, []);

  const closeToast = useCallback((id: string) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  // ... confirm logic (keep existing) ...
  const confirm = useCallback((title: string, message: string): Promise<boolean> => {
    return new Promise((resolve) => {
      setConfirmState({ isOpen: true, title, message, resolve });
    });
  }, []);
  const handleConfirm = () => { if (confirmState.resolve) confirmState.resolve(true); setConfirmState(prev => ({ ...prev, isOpen: false })); };
  const handleCancel = () => { if (confirmState.resolve) confirmState.resolve(false); setConfirmState(prev => ({ ...prev, isOpen: false })); };

  return (
    <UIContext.Provider value={{ showToast, confirm }}>
      {children}
      <div className="fixed top-5 right-5 z-[70] flex flex-col gap-2 pointer-events-none">
        <div className="pointer-events-auto flex flex-col gap-2">
            {toasts.map(t => (
                // Passing action props to Toast component
                <Toast key={t.id} {...t} onClose={closeToast} />
            ))}
        </div>
      </div>
      <ConfirmDialog isOpen={confirmState.isOpen} title={confirmState.title} message={confirmState.message} onConfirm={handleConfirm} onCancel={handleCancel} />
    </UIContext.Provider>
  );
};

export const useUI = () => {
  const context = useContext(UIContext);
  if (!context) throw new Error("useUI must be used within a UIProvider");
  return context;
};
--- FILE END: src\context\UIContext.tsx ---


--- FILE START: src\hooks\usePaginatedData.ts ---

import { useState, useEffect, useCallback } from 'react';
import { ApiService } from '../services/api';
import { getQueryConstraints } from '../utils/helpers';

export const usePaginatedData = (userId: string, col: string, config: any) => {
  const [data, setData] = useState<any[]>([]);
  const [last, setLast] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [hasMore, setHasMore] = useState(true);
  const [idxErr, setIdxErr] = useState(false);

  useEffect(() => {
    setData([]); setLast(null); setHasMore(true); setIdxErr(false); fetchMore(true); 
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [userId, col, config.sortField, config.searchTerm, config.dateFilter?.start, config.dateFilter?.end]);

  const fetchMore = useCallback(async (isInit = false) => {
    if (!userId || (loading && !isInit) || (!isInit && !hasMore)) return;
    setLoading(true); setIdxErr(false);
    try {
      const constraints = getQueryConstraints(config);
      const snap = await ApiService.fetchPaginated(userId, col, constraints, isInit ? null : last);
      const res = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setData(p => isInit ? res : [...p, ...res]);
      setLast(snap.docs[snap.docs.length - 1]);
      setHasMore(snap.docs.length === 100);
    } catch (e: any) { 
        if (e.message === "Missing Index") setIdxErr(true); 
    } finally { 
        setLoading(false); 
    }
  }, [userId, col, config, last, loading, hasMore]);

  const loadMore = () => fetchMore(false);

  return { data, loading, hasMore, idxErr, loadMore, refresh: () => fetchMore(true), setData };
};

// Also export useDebounce here as it's a related utility hook
export function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);
  return debouncedValue;
}
--- FILE END: src\hooks\usePaginatedData.ts ---


--- FILE START: src\hooks\useSwipe.ts ---
import { useState, useEffect, TouchEvent } from 'react';

export const useSwipe = (onSwipeLeft: () => void, onSwipeRight: () => void, minSwipeDistance = 50) => {
  const [touchStart, setTouchStart] = useState<number | null>(null);
  const [touchEnd, setTouchEnd] = useState<number | null>(null);
  const [touchStartY, setTouchStartY] = useState<number | null>(null);
  const [touchEndY, setTouchEndY] = useState<number | null>(null);

  const onTouchStart = (e: TouchEvent) => {
    setTouchEnd(null);
    setTouchStart(e.targetTouches[0].clientX);
    setTouchStartY(e.targetTouches[0].clientY);
  };

  const onTouchMove = (e: TouchEvent) => {
    setTouchEnd(e.targetTouches[0].clientX);
    setTouchEndY(e.targetTouches[0].clientY);
  };

  const onTouchEnd = () => {
    if (!touchStart || !touchEnd || !touchStartY || !touchEndY) return;
    
    const distanceX = touchStart - touchEnd;
    const distanceY = touchStartY - touchEndY;
    const isLeftSwipe = distanceX > minSwipeDistance;
    const isRightSwipe = distanceX < -minSwipeDistance;
    
    // Ensure it's a horizontal swipe (X distance > Y distance) to allow scrolling
    if (Math.abs(distanceX) > Math.abs(distanceY)) {
        if (isLeftSwipe) onSwipeLeft();
        if (isRightSwipe) onSwipeRight();
    }
  };

  return {
    onTouchStart,
    onTouchMove,
    onTouchEnd
  };
};
--- FILE END: src\hooks\useSwipe.ts ---


--- FILE START: src\main.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css'; // <--- THIS LINE IS REQUIRED FOR STYLING

const rootElement = document.getElementById('root');

if (!rootElement) {
  throw new Error("Failed to find the root element.");
}

ReactDOM.createRoot(rootElement).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
--- FILE END: src\main.tsx ---


--- FILE START: src\services\api.ts ---
import { 
  collection, 
  doc, 
  getDocs, 
  getDoc,
  addDoc, 
  updateDoc, 
  deleteDoc, 
  setDoc,
  writeBatch,
  query, 
  where, 
  orderBy, 
  limit, 
  startAfter,
  QuerySnapshot,
  DocumentData
} from 'firebase/firestore';
import { db } from '../config/firebase';

// Helper for generic CRUD
const crud = (col: string) => ({
    getAll: async (uid: string) => getDocs(collection(db, `users/${uid}/${col}`)),
    add: async (uid: string, data: any) => addDoc(collection(db, `users/${uid}/${col}`), data),
    update: async (uid: string, id: string, data: any) => updateDoc(doc(db, `users/${uid}/${col}`, id), data),
    delete: async (uid: string, id: string) => deleteDoc(doc(db, `users/${uid}/${col}`, id)),
});

export const ApiService = {
  // --- GENERIC METHODS (Used by new code) ---
  getAll: async (uid: string, col: string, constraints: any[] = []) => {
      const q = query(collection(db, `users/${uid}/${col}`), ...constraints);
      return await getDocs(q);
  },
  
  add: async (uid: string, col: string, data: any) => {
      return await addDoc(collection(db, `users/${uid}/${col}`), data);
  },

  update: async (uid: string, col: string, id: string, data: any) => {
      return await updateDoc(doc(db, `users/${uid}/${col}`, id), data);
  },

  delete: async (uid: string, col: string, id: string) => {
      return await deleteDoc(doc(db, `users/${uid}/${col}`, id));
  },

  // --- MISSING PAGINATION & BATCH ---
  fetchPaginated: async (uid: string, col: string, constraints: any[] = [], lastDoc: any = null) => {
      let q = query(collection(db, `users/${uid}/${col}`), ...constraints, limit(20));
      if (lastDoc) q = query(q, startAfter(lastDoc));
      return await getDocs(q);
  },

  batchAdd: async (uid: string, items: any[]) => {
      const batch = writeBatch(db);
      items.forEach(item => {
          const { _collection, ...data } = item;
          if (_collection) {
              const ref = doc(collection(db, `users/${uid}/${_collection}`));
              batch.set(ref, data);
          }
      });
      return await batch.commit();
  },

  // --- LEGACY NESTED OBJECTS (Restoring backward compatibility) ---
  settings: {
      get: async (uid: string) => {
          const snap = await getDoc(doc(db, `users/${uid}/settings`, 'config'));
          return snap.exists() ? snap.data() : null;
      },
      save: async (uid: string, data: any) => {
          return await setDoc(doc(db, `users/${uid}/settings`, 'config'), data, { merge: true });
      }
  },

  // Direct Update helper for SettingsView
  updateSettings: async (uid: string, settings: any) => {
      return await setDoc(doc(db, `users/${uid}/settings`, 'config'), settings, { merge: true });
  },

  // Legacy Section Helpers (Fixes "Property 'ledger' does not exist")
  ledger: crud('ledger_entries'),
  parties: crud('parties'),
  transactions: crud('transactions'),
  inventory: crud('inventory'),
  vehicles: crud('vehicles'),
  expenses: crud('expenses')
};

--- FILE END: src\services\api.ts ---


--- FILE START: src\services\backup.ts ---
import { ApiService } from './api';

// Collections to backup
const BACKUP_COLLECTIONS = ['ledger_entries', 'transactions', 'inventory', 'parties', 'expenses', 'vehicles'];

export const BackupService = {
  /**
   * Export all user data to JSON file
   */
  exportToJSON: async (uid: string): Promise<boolean> => {
    try {
      const backupData: Record<string, any[]> = {};
      
      // Fetch all collections in parallel
      const results = await Promise.all(
        BACKUP_COLLECTIONS.map(async (col) => {
          const snap = await ApiService.getAll(uid, col, []);
          return {
            collection: col,
            data: snap.docs.map(d => {
              const data = d.data();
              // Convert Firestore timestamps to ISO strings
              if (data.date && data.date.toDate) {
                data.date = data.date.toDate().toISOString();
              }
              if (data.created_at && data.created_at.toDate) {
                data.created_at = data.created_at.toDate().toISOString();
              }
              return { id: d.id, ...data };
            })
          };
        })
      );

      // Also get settings
      const settings = await ApiService.settings.get(uid);
      
      results.forEach(r => {
        backupData[r.collection] = r.data;
      });
      backupData['settings'] = [settings];

      // Create and download file
      const jsonContent = JSON.stringify(backupData, null, 2);
      const blob = new Blob([jsonContent], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `shopkeeper_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      return true;
    } catch (error) {
      console.error('Backup export failed:', error);
      return false;
    }
  },

  /**
   * Import data from JSON backup file
   */
  importFromJSON: async (uid: string, file: File): Promise<{ success: boolean; message: string; counts?: Record<string, number> }> => {
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      const counts: Record<string, number> = {};
      
      // Process each collection
      for (const col of BACKUP_COLLECTIONS) {
        if (data[col] && Array.isArray(data[col])) {
          const records = data[col].map((item: any) => {
            // Remove id to create new docs, convert date strings back
            const { id, ...rest } = item;
            if (rest.date && typeof rest.date === 'string') {
              rest.date = new Date(rest.date);
            }
            return { collection: col, data: rest };
          });
          
          if (records.length > 0) {
            // Batch add in chunks of 500
            const chunkSize = 400;
            for (let i = 0; i < records.length; i += chunkSize) {
              const chunk = records.slice(i, i + chunkSize);
              await ApiService.batchAdd(uid, chunk);
            }
            counts[col] = records.length;
          }
        }
      }

      // Restore settings if present
      if (data['settings'] && data['settings'][0]) {
        await ApiService.settings.save(uid, data['settings'][0]);
        counts['settings'] = 1;
      }

      return {
        success: true,
        message: 'Backup restored successfully!',
        counts
      };
    } catch (error: any) {
      console.error('Backup import failed:', error);
      return {
        success: false,
        message: `Import failed: ${error.message || 'Invalid file format'}`
      };
    }
  },

  /**
   * Validate backup file structure
   */
  validateBackupFile: async (file: File): Promise<{ valid: boolean; summary?: Record<string, number>; error?: string }> => {
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      const summary: Record<string, number> = {};
      
      for (const col of BACKUP_COLLECTIONS) {
        if (data[col] && Array.isArray(data[col])) {
          summary[col] = data[col].length;
        }
      }
      
      if (data['settings']) {
        summary['settings'] = 1;
      }

      if (Object.keys(summary).length === 0) {
        return { valid: false, error: 'No valid data found in backup file' };
      }

      return { valid: true, summary };
    } catch (error: any) {
      return { valid: false, error: 'Invalid JSON file' };
    }
  }
};

--- FILE END: src\services\backup.ts ---


--- FILE START: src\services\data.ts ---
import { collection, getDocs, writeBatch, doc } from 'firebase/firestore';
import { db } from '../config/firebase';

export const DataService = {
  backupData: async (uid: string) => {
      try {
          const collections = ['ledger_entries', 'transactions', 'parties', 'vehicles', 'inventory', 'expenses', 'settings'];
          const backup: any = {};
          
          for (const col of collections) {
              const snap = await getDocs(collection(db, `users/${uid}/${col}`));
              backup[col] = snap.docs.map(d => ({ ...d.data(), _id: d.id }));
          }
          
          const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          
          return { success: true, message: "Backup Downloaded" };
      } catch (e) {
          console.error(e);
          return { success: false, message: "Backup Failed" };
      }
  }
};

--- FILE END: src\services\data.ts ---


--- FILE START: src\services\export.ts ---

export const ExportService = {
  saveAndOpenFile: async (base64: string, filename: string, mimeType: string) => {
      const link = document.createElement('a');
      link.href = `data:${mimeType};base64,${base64}`;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  },

  // Legacy support for VehicleDetailView
  exportToCSV: async (data: any[], headers: string[], filename: string) => {
      const csvContent = [
          headers.join(','),
          ...data.map(row => headers.map(fieldName => {
              const val = row[fieldName] || '';
              // Escape quotes and wrap in quotes
              return `"${String(val).replace(/"/g, '""')}"`; 
          }).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  }
};

--- FILE END: src\services\export.ts ---


--- FILE START: src\services\gemini.ts ---
import { GEMINI_API_KEY } from '../config/constants';

// Helper to format date as YYYY-MM-DD
const getToday = () => new Date().toISOString().split('T')[0];

export const GeminiService = {
  // FIX: Added explicit return type ': Promise<any[]>'
  processInput: async (text: string, imageFile?: File | null, audioFile?: File | null): Promise<any[]> => {
    try {
      if (!GEMINI_API_KEY || GEMINI_API_KEY.includes('YOUR_API')) {
          alert("Gemini API Key is missing. Check .env file.");
          return [];
      }

      // Default: Gemini 2.0 Flash Experimental (Latest Preview)
      const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
      const MODEL_NAME = "gemini-2.0-flash-exp"; 
      
      const API_URL = `${BASE_URL}${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;

      const parts: any[] = [];
      
      const systemPrompt = `
        You are a smart accounting assistant. Convert command to JSON Array.
        Current Date: ${getToday()}
        
        SCHEMAS (Strict):
        1. "parties": { "collection": "parties", "role": "customer"|"supplier", "name": "...", "contact": "...", "address": "...", "gstin": "..." }
        2. "ledger_entries": { "collection": "ledger_entries", "type": "sell"|"purchase", "date": "YYYY-MM-DD", "party_name": "...", "total_amount": 0, 
             "vehicle": "...", "vehicle_rent": 0, "payment_received_by": "...", "paid_by": "...", "send_to": "...",
             "items": [{ "item_name": "...", "quantity": 0, "rate": 0, "unit": "Pcs", "total": 0 }] }
        3. "transactions": { "collection": "transactions", "type": "received"|"paid", "date": "YYYY-MM-DD", "party_name": "...", "amount": 0, "payment_mode": "Cash" }
        4. "expenses": { "collection": "expenses", "category": "...", "amount": 0, "date": "YYYY-MM-DD", "notes": "..." }
        5. "vehicles": { "collection": "vehicles", "vehicle_number": "...", "owner_name": "..." }
        6. "inventory": { "collection": "inventory", "name": "...", "sale_rate": 0, "purchase_rate": 0 }

        RULES:
        1. Return ONLY the JSON Array. No text.
        2. SPLIT commands: "Add Ayush and Sell 100 bags" -> [ {party}, {ledger_entry} ]
      `;
      
      parts.push({ text: systemPrompt + "\nUSER INPUT: " + (text || "Analyze attached media.") });

      const fileToBase64 = (file: File): Promise<string> => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result?.toString().split(',')[1] || '');
              reader.onerror = reject;
          });
      };

      const media = imageFile || audioFile;
      if (media) {
          const b64 = await fileToBase64(media);
          parts.push({ inline_data: { mime_type: media.type, data: b64 } });
      }

      const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: parts }] })
      });

      if (!response.ok) {
          const errorText = await response.text();
          console.error("Gemini API Error:", errorText);
          
          // Fallback Logic
          if (response.status === 404 && MODEL_NAME === "gemini-2.0-flash-exp") {
             console.log("Retrying with gemini-1.5-flash...");
             // Recursion now works because explicit return type is set
             return GeminiService.processInput(text, imageFile, audioFile); 
          }
          
          throw new Error(`AI Error ${response.status}`);
      }
      
      const data = await response.json();
      const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      
      const jsonStart = rawText.indexOf('[');
      const jsonEnd = rawText.lastIndexOf(']');
      
      if (jsonStart === -1 || jsonEnd === -1) return [];

      const cleanJson = rawText.substring(jsonStart, jsonEnd + 1);
      
      try {
          return JSON.parse(cleanJson);
      } catch (e) {
          return JSON.parse(cleanJson.replace(/\n/g, '').replace(/,(\s*)\]/, ']'));
      }

    } catch (e: any) {
      console.error("Gemini Logic Failure:", e);
      return [];
    }
  }
};

--- FILE END: src\services\gemini.ts ---


--- FILE START: src\services\invoice.ts ---
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import { ExportService } from './export';
import { UserProfile } from '../types';

export const InvoiceService = {
  generateInvoice: async (data: any, profile: UserProfile) => {
    const doc = new jsPDF();
    const isSale = data.type === 'sell';
    
    // 1. Header
    doc.setFontSize(18); doc.text(profile.firm_name || 'INVOICE', 14, 15);
    doc.setFontSize(10); doc.text(profile.address || '', 14, 20);
    doc.text(`Phone: ${profile.contact || ''}`, 14, 25);
    if(profile.gstin) doc.text(`GSTIN: ${profile.gstin}`, 14, 30);

    // 2. Info
    doc.setFontSize(14); doc.text(isSale ? 'SALE INVOICE' : 'PURCHASE ORDER', 140, 15);
    doc.setFontSize(10); doc.text(`Date: ${data.date}`, 140, 22);
    if(data.invoice_no) doc.text(`Invoice #: ${data.invoice_no}`, 140, 27);

    // 3. Bill To
    doc.line(14, 35, 196, 35);
    doc.text(isSale ? 'Bill To:' : 'Supplier:', 14, 42);
    doc.setFontSize(11); doc.text(data.party_name || 'Cash Sale', 14, 48);
    doc.setFontSize(10);
    
    let extraY = 53;
    if (data.party_address) { doc.text(data.party_address, 14, extraY); extraY += 5; }
    if (data.vehicle) { doc.text(`Vehicle: ${data.vehicle}`, 120, 42); if(data.vehicle_rent) doc.text(`Rent: ${data.vehicle_rent}`, 120, 47); }
    if (data.supplier) { doc.text(`Source: ${data.supplier}`, 120, 52); } // Added Source Supplier
    if (data.send_to) { doc.text(`Ship To: ${data.send_to}`, 120, 52); }

    // 4. Items Table (Added HSN & Tax)
    const tableRows = data.items?.map((item: any) => [
        item.item_name,
        item.hsn_code || '-',
        `${item.quantity} ${item.unit}`,
        item.rate,
        item.gst_percent ? `${item.gst_percent}%` : '0%',
        item.total
    ]) || [];

    (doc as any).autoTable({
        startY: 65,
        head: [['Item', 'HSN', 'Qty', 'Rate', 'Tax', 'Total']],
        body: tableRows,
        theme: 'grid'
    });

    // 5. Totals
    const finalY = (doc as any).lastAutoTable.finalY + 10;
    doc.setFontSize(12);
    doc.text(`Grand Total: ${profile.currency_symbol}${data.total_amount}`, 140, finalY);
    
    if (data.notes) doc.text(`Note: ${data.notes}`, 14, finalY + 10);

    // 6. Save
    const pdfData = doc.output('datauristring').split(',')[1];
    await ExportService.saveAndOpenFile(pdfData, `Invoice_${data.party_name}.pdf`, 'application/pdf');
  },

  generateReceipt: async (data: any, profile: UserProfile) => {
      const doc = new jsPDF();
      doc.setFontSize(16); doc.text("PAYMENT RECEIPT", 105, 15, { align: 'center' });
      doc.setFontSize(10); doc.text(profile.firm_name, 105, 22, { align: 'center' });
      
      doc.rect(20, 35, 170, 80);
      doc.text(`Date: ${data.date}`, 150, 45);
      
      doc.setFontSize(14); doc.text(data.party_name, 80, 60);
      doc.setFontSize(16); doc.text(`${profile.currency_symbol}${data.amount}`, 80, 75);
      
      doc.setFontSize(10);
      doc.text(`Mode: ${data.payment_mode || 'Cash'}`, 30, 90);
      if(data.payment_purpose) doc.text(`Purpose: ${data.payment_purpose}`, 30, 100);

      const pdfData = doc.output('datauristring').split(',')[1];
      await ExportService.saveAndOpenFile(pdfData, `Receipt_${data.party_name}.pdf`, 'application/pdf');
  }
};

--- FILE END: src\services\invoice.ts ---


--- FILE START: src\services\sanitizer.ts ---

export const Sanitizer = {
    // Safely converts null/undefined to empty string
    asString: (val: any) => (val === null || val === undefined) ? '' : String(val),
    
    // Safely converts invalid numbers to 0 (MISSING IN YOUR CODE)
    asNumber: (val: any) => {
        if (val === null || val === undefined) return 0;
        const num = Number(val);
        return isNaN(num) ? 0 : num;
    },

    // Removes duplicates and empty values from a list
    cleanList: (list: any[]) => {
        if (!Array.isArray(list)) return [];
        return Array.from(new Set(list))
            .filter(item => item !== null && item !== undefined && item !== '')
            .sort();
    }
};

--- FILE END: src\services\sanitizer.ts ---


--- FILE START: src\services\statement.ts ---
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { ExportService } from './export';
import { ApiService } from './api';
import { where, orderBy, getDocs, query, collection } from 'firebase/firestore';
import { db } from '../config/firebase';

export const StatementService = {
  generatePartyStatement: async (uid: string, party: any, startDate: string, endDate: string, firmProfile: any) => {
    // 1. Fetch Data
    const ledgerRef = collection(db, `users/${uid}/ledger_entries`);
    const txRef = collection(db, `users/${uid}/transactions`);
    
    // We fetch broadly and filter in JS for simpler date handling
    const qLedger = query(ledgerRef, where('party_name', '==', party.name));
    const qTx = query(txRef, where('party_name', '==', party.name));
    
    const [lSnap, tSnap] = await Promise.all([getDocs(qLedger), getDocs(qTx)]);
    
    // 2. Combine & Sort
    let allEntries = [
        ...lSnap.docs.map(d => ({ ...d.data(), _type: 'BILL' })),
        ...tSnap.docs.map(d => ({ ...d.data(), _type: 'PAYMENT' }))
    ];
    
    // Sort by date ascending
    allEntries.sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime());

    // 3. Calculate Opening Balance before Start Date
    let runningBalance = 0; // Assume 0 start for absolute history, or use party.opening_balance logic
    // Simplified: We just show the list within range for now. 
    // In a real accounting app, we'd calculate 'Balance Brought Forward'.
    
    const filteredEntries = allEntries.filter((e: any) => e.date >= startDate && e.date <= endDate);

    // 4. Generate PDF
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.setTextColor(41, 128, 185);
    doc.text(firmProfile.firm_name, 14, 15);
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Statement of Account: ${party.name}`, 14, 22);
    doc.text(`Period: ${startDate} to ${endDate}`, 14, 27);
    
    // Table Rows
    const rows = filteredEntries.map((e: any) => {
        const isBill = e._type === 'BILL';
        const debit = isBill ? (e.total_amount || 0) : 0;
        const credit = !isBill ? (e.amount || 0) : 0;
        
        // Simple running balance logic for the view
        if(isBill) runningBalance += debit;
        else runningBalance -= credit;

        return [
            e.date,
            isBill ? `Inv #${e.invoice_no || '-'} - ${e.items?.length || 0} Items` : `Pmt: ${e.payment_mode}`,
            debit > 0 ? debit.toFixed(2) : '-',
            credit > 0 ? credit.toFixed(2) : '-',
            runningBalance.toFixed(2)
        ];
    });

    (doc as any).autoTable({
        head: [['Date', 'Description', 'Debit (Bill)', 'Credit (Paid)', 'Balance']],
        body: rows,
        startY: 35,
        theme: 'striped',
        headStyles: { fillColor: [41, 128, 185], textColor: 255 },
        columnStyles: {
            2: { halign: 'right' },
            3: { halign: 'right' },
            4: { halign: 'right', fontStyle: 'bold' }
        }
    });

    // Save
    const pdfOutput = doc.output('datauristring').split(',')[1];
    await ExportService.saveAndOpenFile(pdfOutput, `Statement_${party.name}.pdf`, 'application/pdf');
  }
};

--- FILE END: src\services\statement.ts ---


--- FILE START: src\types\index.ts ---

export interface UserProfile {
  firm_name: string;
  address: string;
  gstin: string;
  contact: string;
  state: string;
  financial_year_start: string;
  currency_symbol: string;
  date_format: string;
  invoice_prefix: string;
}

export interface RolePermissions {
  can_delete: boolean;
  can_export: boolean;
  can_edit_locked: boolean;
  allowed_sections: string[];
}

export interface AutomationSettings {
  enable_date_filter: boolean;
  auto_calculate_gst: boolean;
  auto_update_inventory: boolean;
  show_delete_btn: boolean;
  enable_vibration: boolean;
  allow_negative_stock: boolean; // --- FIXED VARIABLE NAME ---
  default_payment_mode: string;
  default_gst_percent: number;
  default_price_type: 'inclusive' | 'exclusive';
  default_unit: string;
}

export interface SecuritySettings {
    enabled: boolean;
    pin: string;
    timeout: number;
    enable_biometrics: boolean;
}

export interface AISettings {
  enabled: boolean;
  language: string;
  auto_process: boolean;
}

export interface UserDefaults {
  payment_mode: string;
  gst_percent: number;
  price_type: string;
  unit: string;
}

export interface FieldVisibility {
  transactions: { received_by: boolean; payment_purpose: boolean; notes: boolean; payment_mode: boolean; paid_by: boolean; };
  ledger: { address: boolean; vehicle: boolean; vehicle_rent: boolean; notes: boolean; invoice_no: true; payment_received_by: true; paid_to: true };
  inventory: { hsn_code: boolean; gst_percent: boolean; price_type: boolean; supplier_name: boolean; default_rate: boolean };
  parties: { gstin: boolean; site: boolean; state: boolean; address: boolean };
  vehicles: { driver_name: boolean; model: boolean; notes: boolean };
}

export interface AppSettings {
  profile: UserProfile;
  roles: { owner: RolePermissions; manager: RolePermissions; accountant: RolePermissions; staff: RolePermissions };
  automation: AutomationSettings;
  security: SecuritySettings;
  ai: AISettings;
  defaults: UserDefaults;
  active_role: 'owner' | 'manager' | 'accountant' | 'staff';
  field_visibility: FieldVisibility;
  custom_lists: {
      expense_types: string[];
      payment_modes: string[];
      received_by_names: string[];
      paid_by_names: string[];
      purposes: string[];
  };
}

--- FILE END: src\types\index.ts ---


--- FILE START: src\types.ts ---

export interface UserProfile {
  firm_name: string;
  owner_name: string;
  contact: string;
  address: string;
  gstin: string;
  currency_symbol: string;
}

export interface AppSettings {
  profile: UserProfile;
  preferences: {
      dark_mode: boolean;
      haptics_enabled: boolean;
      language: string;
  };
  security?: { // Added optional Security object
      enabled: boolean;
      pin: string;
      enable_biometrics: boolean;
  };
  automation: {
      enable_date_filter: boolean;
      auto_calculate_gst: boolean;
      auto_update_inventory: boolean;
      show_delete_btn: boolean;
      enable_vibration: boolean;
      default_unit: string;
      low_stock_warning: boolean;
      allow_negative_stock: boolean;
  };
  field_visibility: {
      ledger: {
          invoice_no: boolean;
          vehicle: boolean;
          vehicle_rent: boolean;
          payment_received_by: boolean;
          notes: boolean;
          address: boolean;
          paid_to: boolean;
      };
      transactions: {
          received_by: boolean;
          paid_by: boolean;
          notes: boolean;
      };
      inventory: {
          hsn_code: boolean;
          gst_percent: boolean;
          price_type: boolean;
          supplier_name: boolean;
      };
      parties: {
          gstin: boolean;
          address: boolean;
          site: boolean;
          state: boolean;
      };
      vehicles: {
          driver_name: boolean;
          model: boolean;
          notes: boolean;
      };
  };
  custom_lists: {
      expense_types: string[];
      payment_modes: string[];
      received_by_names: string[];
      paid_by_names: string[];
      purposes: string[];
  };
}

--- FILE END: src\types.ts ---


--- FILE START: src\utils\haptics.ts ---

export const setHapticsEnabled = (enabled: boolean) => {
    localStorage.setItem('haptics_enabled', String(enabled));
};

export const vibrate = (pattern: number | number[]) => {
    const enabled = localStorage.getItem('haptics_enabled') !== 'false';
    if (enabled && navigator.vibrate) {
        navigator.vibrate(pattern);
    }
};

// FULL COMPATIBILITY OBJECT
// Includes both standard methods (impact, notification) 
// AND legacy aliases (medium, success, error)
export const haptic = {
    // Standard Methods
    impact: (style: 'light' | 'medium' | 'heavy' = 'medium') => vibrate(style === 'heavy' ? 20 : style === 'medium' ? 10 : 5),
    notification: (type: 'success' | 'warning' | 'error') => {
        if (type === 'error') vibrate([50, 100, 50]);
        else if (type === 'success') vibrate([10, 50, 10]);
        else vibrate([30, 30]);
    },
    selection: () => vibrate(5),

    // Legacy Aliases (Fixes your build errors)
    light: () => vibrate(5),
    medium: () => vibrate(10),
    heavy: () => vibrate(20),
    success: () => vibrate([10, 50, 10]),
    warning: () => vibrate([30, 30]),
    error: () => vibrate([50, 100, 50])
};

--- FILE END: src\utils\haptics.ts ---


--- FILE START: src\utils\helpers.ts ---
import { where, orderBy } from 'firebase/firestore';

export const formatCurrency = (amount: number | string) => {
  const num = Number(amount);
  if (isNaN(num)) return '0.00';
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    minimumFractionDigits: 2
  }).format(num);
};

export const formatDate = (date: any) => {
  if (!date) return '';
  const d = date.toDate ? date.toDate() : new Date(date);
  return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
};

// FIXED: Returns strict local YYYY-MM-DD without timezone shifts
export const getCurrentMonthRange = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); 
  
  // Create dates at noon to avoid DST/midnight shifts
  const start = new Date(year, month, 1, 12, 0, 0);
  const end = new Date(year, month + 1, 0, 12, 0, 0);

  const toLocalISO = (d: Date) => {
      const offset = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - offset).toISOString().split('T')[0];
  };

  return { 
      start: toLocalISO(start), 
      end: toLocalISO(end) 
  };
};

export const getDateObj = (date: any) => {
    return date && date.toDate ? date.toDate() : new Date(date || 0);
};

export const calculateAccounting = (ledger: any[], transactions: any[], role: string) => {
    let totalBilled = 0;
    let totalPaid = 0;

    ledger.forEach(l => {
        if((role === 'customer' && l.type === 'sell') || (role === 'supplier' && l.type === 'purchase')) {
            totalBilled += (Number(l.total_amount) || 0);
        }
    });

    transactions.forEach(t => {
        if((role === 'customer' && t.type === 'received') || (role === 'supplier' && t.type === 'paid')) {
            totalPaid += (Number(t.amount) || 0);
        }
    });

    return { totalBilled, totalPaid, balance: totalBilled - totalPaid };
};

export const getQueryConstraints = (config: any) => {
    const constraints: any[] = [];
    if (config.dateFilter?.start && config.dateFilter?.end) {
        const start = new Date(config.dateFilter.start);
        const end = new Date(config.dateFilter.end);
        end.setHours(23, 59, 59, 999);
        constraints.push(where('date', '>=', start));
        constraints.push(where('date', '<=', end));
    }
    if (config.sortField) {
        constraints.push(orderBy(config.sortField, config.sortDirection || 'desc'));
    }
    return constraints;
};
--- FILE END: src\utils\helpers.ts ---
